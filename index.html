<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>名古屋・貓之旅 2026</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#FAF9F6', // 米白色
                            text: '#3E3A39', // 深灰
                            accent: '#E65100', // 深橘
                            card: '#FFFFFF',
                            line: '#D1D1D1'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        round: ['"Zen Maru Gothic"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FAF9F6;
            color: #3E3A39;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 隱藏捲軸但保留功能 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 貓掌選取效果 */
        .paw-icon {
            display: none;
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1.5rem;
            color: #E65100;
            background: white;
            border-radius: 50%;
            padding: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .itinerary-card.selected {
            border: 2px solid #E65100;
            background-color: #FFF3E0;
            transform: scale(1.02);
        }

        .itinerary-card.selected .paw-icon {
            display: block;
        }
        
        .timeline-dot.selected {
            background-color: #E65100;
            border-color: white;
            transform: scale(1.3);
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* Tab 轉換動畫 */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #E65100;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24 font-sans antialiased">

    <header class="fixed top-0 w-full z-40 bg-muji-bg/95 backdrop-blur-sm shadow-sm border-b border-muji-line/30 transition-all duration-300" id="main-header">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold font-round text-muji-text tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-cat text-muji-accent"></i>
                <span>名古屋・貓之旅</span>
            </h1>
            <div class="text-xs text-muji-accent font-bold border border-muji-accent px-2 py-1 rounded-full">
                2026.02
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-20">

        <section id="plan" class="tab-content active">
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border-l-4 border-muji-accent">
                <h3 class="font-bold text-lg mb-3 font-round flex items-center gap-2">
                    <i class="fa-solid fa-plane-departure text-muji-accent"></i> 航班資訊
                </h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center border-b pb-2 border-dashed">
                        <div>
                            <span class="block text-gray-500 text-xs">2/06 去程 (CI 0154)</span>
                            <span class="font-bold text-lg">07:35</span> TPE
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-300"></i>
                        <div class="text-right">
                            <span class="block text-gray-500 text-xs">11:05 抵達</span>
                            <span class="font-bold text-lg">NGO</span> 名古屋
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="block text-gray-500 text-xs">2/14 回程 (CI 0151)</span>
                            <span class="font-bold text-lg">09:50</span> NGO
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-300"></i>
                        <div class="text-right">
                            <span class="block text-gray-500 text-xs">12:15 抵達</span>
                            <span class="font-bold text-lg">TPE</span> 台北
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8 relative">
                <div class="absolute left-[19px] top-8 bottom-0 w-[2px] bg-gray-200"></div>
                <h2 class="font-round text-2xl font-bold mb-4 text-muji-text sticky top-16 bg-muji-bg z-30 py-2">Day 1 <span class="text-sm font-normal text-gray-500">2/06 (五)</span></h2>

                <div id="d1-container">
                    </div>
            </div>

            <div class="mb-8 relative">
                <div class="absolute left-[19px] top-8 bottom-0 w-[2px] bg-gray-200"></div>
                <h2 class="font-round text-2xl font-bold mb-4 text-muji-text sticky top-16 bg-muji-bg z-30 py-2">Day 2 <span class="text-sm font-normal text-gray-500">2/07 (六)</span></h2>
                
                <div id="d2-container">
                    </div>
            </div>
        </section>

        <section id="guide" class="tab-content">
            <h2 class="font-round text-2xl font-bold mb-6">深度導覽</h2>
            
            <article class="bg-white rounded-xl overflow-hidden shadow-sm mb-6">
                <div class="h-40 bg-gray-200 relative">
                     <img src="https://images.unsplash.com/photo-1540541338287-41700207dee6?auto=format&fit=crop&q=80&w=800" class="w-full h-full object-cover" alt="Nagoya">
                     <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">
                         <h3 class="text-white font-bold text-xl font-round">名古屋車站迷宮</h3>
                     </div>
                </div>
                <div class="p-5">
                    <p class="text-sm text-gray-600 leading-relaxed mb-4">
                        <span class="text-4xl float-left mr-2 font-serif text-muji-accent">名</span>
                        古屋站（Nagoya Station）是金氏世界紀錄認證「全世界賣場面積最大的車站」。這裡不只是交通樞紐，更是購物天堂。JR Gate Tower 與中央塔樓相連，形成了巨大的垂直城市。
                    </p>
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-4">
                        <h4 class="font-bold text-muji-accent text-sm mb-1"><i class="fa-solid fa-lightbulb"></i> 冷知識</h4>
                        <p class="text-xs text-gray-600">名古屋人俗稱這裡為「名駅 (Meieki)」，如果你看到路標寫 Meieki，指的就是這一區喔！此外，車站著名的地標「娜娜醬人偶 (Nana-chan)」身高 6.1 公尺，會隨季節換裝，記得去合照！</p>
                    </div>
                </div>
            </article>

            <article class="bg-white rounded-xl overflow-hidden shadow-sm mb-6">
                 <div class="h-40 bg-gray-200 relative">
                     <img src="https://images.unsplash.com/photo-1579619626359-2c676997cb66?auto=format&fit=crop&q=80&w=800" class="w-full h-full object-cover" alt="Suzuka">
                     <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">
                         <h3 class="text-white font-bold text-xl font-round">鈴鹿賽車場</h3>
                     </div>
                </div>
                <div class="p-5">
                    <p class="text-sm text-gray-600 leading-relaxed">
                        F1日本大獎賽的舉辦地。不同於一般遊樂園，這裡充滿了「本田魂 (Honda Spirit)」。MOTOPIA 樂園的設計理念是讓孩子們從小就能體驗「自己駕駛的樂趣」，許多設施都需要孩子親自操控油門與方向盤，而非被動乘坐。
                    </p>
                </div>
            </article>
        </section>

        <section id="wallet" class="tab-content">
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6 sticky top-20 z-20 border border-gray-100">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs text-gray-500">匯率設定 (1 JPY = ? TWD)</label>
                    <input type="number" id="exchange-rate" value="0.215" step="0.001" class="w-20 text-right border-b border-muji-accent focus:outline-none text-sm font-bold bg-transparent" onchange="updateTotal()">
                </div>
                
                <div class="bg-gray-100 rounded-lg p-3 mb-3 text-right">
                    <div id="calc-expression" class="text-xs text-gray-500 h-4"></div>
                    <input type="text" id="calc-display" class="w-full bg-transparent text-2xl font-bold text-right focus:outline-none font-mono" placeholder="0" readonly>
                    <div class="text-muji-accent text-sm mt-1 font-bold">
                        ≈ NT$ <span id="calc-twd">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <button onclick="calcAppend('7')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">7</button>
                    <button onclick="calcAppend('8')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">8</button>
                    <button onclick="calcAppend('9')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">9</button>
                    <button onclick="calcAppend('/')" class="p-3 bg-orange-50 text-muji-accent rounded-lg font-bold active:bg-orange-100">÷</button>
                    
                    <button onclick="calcAppend('4')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">4</button>
                    <button onclick="calcAppend('5')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">5</button>
                    <button onclick="calcAppend('6')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">6</button>
                    <button onclick="calcAppend('*')" class="p-3 bg-orange-50 text-muji-accent rounded-lg font-bold active:bg-orange-100">×</button>
                    
                    <button onclick="calcAppend('1')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">1</button>
                    <button onclick="calcAppend('2')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">2</button>
                    <button onclick="calcAppend('3')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">3</button>
                    <button onclick="calcAppend('-')" class="p-3 bg-orange-50 text-muji-accent rounded-lg font-bold active:bg-orange-100">-</button>
                    
                    <button onclick="calcClear()" class="p-3 bg-red-50 text-red-500 rounded-lg font-bold active:bg-red-100">C</button>
                    <button onclick="calcAppend('0')" class="p-3 bg-gray-50 rounded-lg font-bold active:bg-gray-200">0</button>
                    <button onclick="calcEval()" class="p-3 bg-muji-accent text-white rounded-lg font-bold shadow-md active:bg-orange-800">=</button>
                    <button onclick="calcAppend('+')" class="p-3 bg-orange-50 text-muji-accent rounded-lg font-bold active:bg-orange-100">+</button>
                </div>
                
                <div class="mt-3 pt-3 border-t border-gray-100 flex gap-2">
                    <input type="text" id="expense-item" placeholder="品項名稱" class="flex-1 bg-gray-50 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-muji-accent">
                    
                    <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoSelect(this)">
                    <button onclick="document.getElementById('expense-photo').click()" class="w-10 flex items-center justify-center bg-gray-100 rounded-lg text-gray-500 relative">
                        <i class="fa-solid fa-camera"></i>
                        <span id="photo-indicator" class="hidden absolute top-0 right-0 w-2 h-2 bg-green-500 rounded-full"></span>
                    </button>
                    
                    <button onclick="addExpense()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold">記帳</button>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold font-round text-lg">記帳列表 <span class="text-sm font-normal text-gray-500" id="total-expense"></span></h3>
                <div id="expense-list" class="space-y-2 pb-10">
                    </div>
                <button onclick="clearExpenses()" class="w-full text-center text-xs text-gray-400 py-4 underline">清除所有記錄</button>
            </div>
        </section>

        <section id="lists" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <h3 class="font-round font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-muji-accent"></i> 行前準備
                </h3>
                <div id="checklist-container" class="space-y-2">
                    </div>
                <div class="flex mt-4 gap-2">
                    <input type="text" id="new-check-item" placeholder="新增項目..." class="flex-1 border-b border-gray-300 focus:outline-none focus:border-muji-accent text-sm py-1 bg-transparent">
                    <button onclick="addCheckItem()" class="text-muji-accent"><i class="fa-solid fa-plus-circle text-xl"></i></button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <h3 class="font-round font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-regular fa-note-sticky text-muji-accent"></i> 備忘錄
                </h3>
                <textarea id="memo-area" class="w-full h-40 p-3 bg-yellow-50 rounded-lg text-sm leading-relaxed focus:outline-none focus:ring-1 focus:ring-muji-accent resize-none placeholder-gray-400" placeholder="隨手記下筆記，輸入網址會自動變連結..." oninput="saveMemo()"></textarea>
                <div id="memo-links" class="mt-3 flex flex-wrap gap-2">
                    </div>
            </div>
        </section>

        <section id="info" class="tab-content">
            <h2 class="font-round text-2xl font-bold mb-6">旅遊資訊</h2>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-xl flex flex-col items-center justify-center gap-2 text-blue-600 hover:bg-blue-100 transition">
                    <i class="fa-solid fa-cloud-sun text-3xl"></i>
                    <span class="font-bold text-sm">日本氣象廳</span>
                </a>
                <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="bg-pink-50 p-4 rounded-xl flex flex-col items-center justify-center gap-2 text-pink-600 hover:bg-pink-100 transition">
                    <i class="fa-solid fa-store text-3xl"></i>
                    <span class="font-bold text-sm">附近藥妝店</span>
                </a>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                <div class="bg-red-50 p-3 border-b border-red-100">
                    <h3 class="text-red-600 font-bold flex items-center gap-2">
                        <i class="fa-solid fa-phone-volume"></i> 緊急聯絡
                    </h3>
                </div>
                <div class="p-4 space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span>警察局</span>
                        <a href="tel:110" class="font-mono font-bold bg-gray-100 px-3 py-1 rounded-full">110</a>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>火警/救護車</span>
                        <a href="tel:119" class="font-mono font-bold bg-gray-100 px-3 py-1 rounded-full">119</a>
                    </div>
                    <div class="pt-2 border-t text-xs text-gray-500">
                        <p class="mb-1">台北駐大阪經濟文化辦事處 (名古屋分處)</p>
                        <p>電話：090-XXXX-XXXX (急難救助)</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <h3 class="font-bold mb-3 font-round">⚠️ 注意事項</h3>
                <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                    <li>日本電壓 100V，插頭為雙平腳（與台灣相同）。</li>
                    <li>購物滿 5,500 日圓可退稅，需出示護照。</li>
                    <li>電車內請將手機設為靜音，避免通話。</li>
                    <li>禁止攜帶肉類製品回台灣。</li>
                </ul>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 pb-safe pt-1 z-50">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center gap-1 w-full text-gray-400 hover:text-muji-accent transition-colors">
                <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
                <span class="text-[10px] font-bold">行程</span>
            </button>
            <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400 hover:text-muji-accent transition-colors">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
                <span class="text-[10px] font-bold">導覽</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400 hover:text-muji-accent transition-colors">
                <div class="bg-muji-accent text-white rounded-full w-10 h-10 flex items-center justify-center -mt-6 shadow-lg border-4 border-muji-bg">
                    <i class="fa-solid fa-yen-sign text-lg"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">記帳</span>
            </button>
            <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400 hover:text-muji-accent transition-colors">
                <i class="fa-solid fa-list-check text-xl mb-1"></i>
                <span class="text-[10px] font-bold">清單</span>
            </button>
            <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400 hover:text-muji-accent transition-colors">
                <i class="fa-solid fa-circle-info text-xl mb-1"></i>
                <span class="text-[10px] font-bold">資訊</span>
            </button>
        </div>
    </nav>

    <script>
        // Data & State
        const ITINERARY = {
            d1: [
                { time: "03:30", title: "機場接送", desc: "家裡 -> 桃園機場", type: "transport" },
                { time: "07:35", title: "起飛 CI 0154", desc: "飛往名古屋", type: "flight", important: true },
                { time: "11:05", title: "抵達名古屋", desc: "中部國際機場", type: "flight" },
                { time: "12:00", title: "取車", desc: "〒479-0881 Aichi, Tokoname, Centrair, 1-chōme−1 1 第一", type: "car", map: "〒479-0881 Aichi, Tokoname, Centrair, 1-chōme−1 1 第一" },
                { time: "13:30", title: "JR Gate Tower Mall", desc: "中餐與逛 Bic Camera", type: "food", map: "1-1-4 Meieki, Nakamura-ku, Nagoya-shi, Aichi 450-6001" },
                { time: "16:00", title: "前往鈴鹿", desc: "開車移動", type: "transport" },
                { time: "18:00", title: "住宿：鈴鹿賽車樂園酒店", desc: "7992 Inoucho, Suzuka, Mie 510-0201", type: "hotel", map: "7992 Inoucho, Suzuka, Mie 510-0201" }
            ],
            d2: [
                { time: "09:00", title: "鈴鹿賽車樂園", desc: "玩到 17:00", type: "play", important: true, link: "https://www.suzukacircuit.jp/tw/" },
                { time: "17:00", title: "前往名古屋市區", desc: "開車移動", type: "transport" },
                { time: "19:00", title: "住宿：Airbnb", desc: "愛知縣名古屋市緑區鳴海町字作町26號", type: "hotel", map: "愛知縣名古屋市緑區鳴海町字作町26號" }
            ]
        };

        const DEFAULT_CHECKLIST = [
            { text: "護照 (有效期限6個月以上)", checked: false },
            { text: "Visit Japan Web 填寫截圖", checked: false },
            { text: "網卡 / Roaming 開通", checked: false },
            { text: "日幣現金", checked: false },
            { text: "信用卡 (海外回饋高)", checked: false },
            { text: "個人常備藥品", checked: false },
            { text: "手機充電線 / 行動電源", checked: false }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderItinerary('d1', ITINERARY.d1);
            renderItinerary('d2', ITINERARY.d2);
            loadWallet();
            loadLists();
            
            // Check active tab styling
            const activeTab = document.querySelector('.nav-btn.active');
            if(activeTab) activeTab.classList.replace('text-gray-400', 'text-muji-accent');
        });

        // --- Navigation ---
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById(tabId).classList.add('active');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-muji-accent');
                btn.classList.add('text-gray-400');
            });
            event.currentTarget.classList.remove('text-gray-400');
            event.currentTarget.classList.add('text-muji-accent');
            
            window.scrollTo(0, 0);
        }

        // --- Plan / Itinerary Logic ---
        function renderItinerary(containerId, items) {
            const container = document.getElementById(`${containerId}-container`);
            let html = '';
            
            items.forEach((item, index) => {
                const iconMap = {
                    flight: 'fa-plane',
                    transport: 'fa-car',
                    food: 'fa-utensils',
                    hotel: 'fa-bed',
                    play: 'fa-ticket',
                    car: 'fa-key'
                };
                const icon = iconMap[item.type] || 'fa-circle';
                const bgClass = item.important ? 'bg-orange-50 border-orange-200' : 'bg-white border-transparent';
                
                let actionBtns = '';
                if(item.map) {
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.map)}`;
                    // Embed logic (simplified iframe due to no API key, falling back to link mostly but showing iframe for visual)
                    const embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(item.map)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
                    
                    actionBtns += `
                        <div class="mt-3 pt-2 border-t border-dashed border-gray-200">
                             <iframe class="w-full h-24 rounded-lg bg-gray-100 mb-2 pointer-events-none" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="${embedUrl}"></iframe>
                             <a href="${mapUrl}" target="_blank" class="text-xs flex items-center gap-1 text-blue-600 font-bold bg-blue-50 px-3 py-2 rounded-lg inline-block w-full text-center">
                                <i class="fa-solid fa-map-location-dot"></i> 開啟 Google Maps
                            </a>
                        </div>
                    `;
                }
                if(item.link) {
                     actionBtns += `
                        <div class="mt-2">
                             <a href="${item.link}" target="_blank" class="text-xs flex items-center gap-1 text-muji-accent font-bold bg-orange-50 px-3 py-2 rounded-lg inline-block w-full text-center">
                                <i class="fa-solid fa-link"></i> 查看詳情
                            </a>
                        </div>
                    `;
                }

                html += `
                <div class="flex gap-4 mb-6 relative group cursor-pointer" onclick="toggleItinerary(this)">
                    <div class="flex flex-col items-center z-10 w-10 shrink-0">
                        <div class="timeline-dot w-4 h-4 rounded-full bg-gray-300 border-2 border-white shadow-sm transition-all duration-300 ${item.important ? 'bg-muji-accent' : ''}"></div>
                        <div class="text-[10px] font-bold text-gray-400 mt-1 font-mono">${item.time}</div>
                    </div>
                    
                    <div class="itinerary-card flex-1 p-4 rounded-xl shadow-sm border transition-all duration-300 relative ${bgClass}">
                        <div class="paw-icon"><i class="fa-solid fa-paw"></i></div>
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-muji-text text-base">${item.title}</h4>
                            <i class="fa-solid ${icon} text-gray-300 text-sm"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${item.desc}</p>
                        ${actionBtns}
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function toggleItinerary(el) {
            // Remove active from others in the same day (optional, or allow multiple)
            // el.parentElement.querySelectorAll('.itinerary-card').forEach(c => c.classList.remove('selected'));
            // el.parentElement.querySelectorAll('.timeline-dot').forEach(d => d.classList.remove('selected'));

            const card = el.querySelector('.itinerary-card');
            const dot = el.querySelector('.timeline-dot');
            
            card.classList.toggle('selected');
            dot.classList.toggle('selected');
        }

        // --- Wallet Logic ---
        let expenses = [];
        let currentPhoto = null;

        function loadWallet() {
            const saved = localStorage.getItem('trip_expenses');
            if(saved) expenses = JSON.parse(saved);
            renderExpenses();
            updateTotal();
        }

        function calcAppend(val) {
            const display = document.getElementById('calc-display');
            if(display.value === '0' && val !== '.') display.value = val;
            else display.value += val;
            updateTotal();
        }

        function calcClear() {
            document.getElementById('calc-display').value = '';
            document.getElementById('calc-expression').innerText = '';
            updateTotal();
        }

        function calcEval() {
            const display = document.getElementById('calc-display');
            const exprDisplay = document.getElementById('calc-expression');
            try {
                // Safe-ish eval for calculator
                const result = Function('"use strict";return (' + display.value + ')')();
                exprDisplay.innerText = display.value + ' =';
                display.value = result;
                updateTotal();
            } catch (e) {
                display.value = 'Error';
            }
        }

        function updateTotal() {
            const display = document.getElementById('calc-display').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.215;
            const twdEl = document.getElementById('calc-twd');
            
            // Try to evaluate if user is typing (e.g. "500*3")
            try {
                const val = Function('"use strict";return (' + (display || 0) + ')')();
                twdEl.innerText = Math.round(val * rate).toLocaleString();
            } catch {
                twdEl.innerText = '-';
            }
        }

        function handlePhotoSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Compress image to Base64
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Max dimension 200px for thumbnail (Save storage)
                    const MAX_SIZE = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height *= MAX_SIZE / width;
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width *= MAX_SIZE / height;
                            height = MAX_SIZE;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Low quality jpeg
                    currentPhoto = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('photo-indicator').classList.remove('hidden');
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        function addExpense() {
            const display = document.getElementById('calc-display');
            const itemInput = document.getElementById('expense-item');
            
            // Calc value first if it's an expression
            try {
                let amount = Function('"use strict";return (' + (display.value || 0) + ')')();
                if(amount <= 0 || itemInput.value.trim() === '') {
                    alert('請輸入金額與品項');
                    return;
                }

                const expense = {
                    id: Date.now(),
                    item: itemInput.value,
                    amount: amount,
                    photo: currentPhoto,
                    date: new Date().toLocaleString()
                };
                
                expenses.unshift(expense);
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
                
                // Reset form
                itemInput.value = '';
                currentPhoto = null;
                document.getElementById('photo-indicator').classList.add('hidden');
                document.getElementById('expense-photo').value = ''; // clear file input
                
                renderExpenses();

            } catch(e) {
                alert('金額格式錯誤');
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-expense');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.215;
            
            let html = '';
            let totalJPY = 0;

            expenses.forEach(ex => {
                totalJPY += parseFloat(ex.amount);
                const twd = Math.round(ex.amount * rate);
                
                html += `
                <div class="flex items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                    ${ex.photo ? `<img src="${ex.photo}" class="w-12 h-12 rounded bg-gray-200 object-cover mr-3 cursor-pointer" onclick="viewImage('${ex.photo}')">` : '<div class="w-12 h-12 rounded bg-gray-100 mr-3 flex items-center justify-center text-gray-300"><i class="fa-solid fa-receipt"></i></div>'}
                    <div class="flex-1">
                        <div class="font-bold text-sm text-gray-800">${ex.item}</div>
                        <div class="text-[10px] text-gray-400">${ex.date.split(' ')[0]}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold font-mono">¥${ex.amount.toLocaleString()}</div>
                        <div class="text-xs text-gray-400">≈ $${twd.toLocaleString()}</div>
                    </div>
                    <button onclick="removeExpense(${ex.id})" class="ml-3 text-gray-300 hover:text-red-400">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
                `;
            });
            
            list.innerHTML = html;
            totalEl.innerText = `(總計 ¥${totalJPY.toLocaleString()})`;
        }

        function removeExpense(id) {
            if(confirm('確定刪除此筆記錄？')) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }
        
        function clearExpenses() {
            if(confirm('確定清除所有記帳資料？無法復原喔！')) {
                expenses = [];
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }
        
        function viewImage(src) {
            // Simple modal view could be implemented, for now simple open
            const w = window.open("");
            w.document.write('<img src="'+src+'" style="width:100%"/>');
        }

        // --- Lists Logic ---
        let checklist = [];

        function loadLists() {
            // Checklist
            const savedCheck = localStorage.getItem('trip_checklist');
            if(savedCheck) checklist = JSON.parse(savedCheck);
            else checklist = JSON.parse(JSON.stringify(DEFAULT_CHECKLIST));
            renderChecklist();

            // Memo
            const savedMemo = localStorage.getItem('trip_memo');
            if(savedMemo) {
                document.getElementById('memo-area').value = savedMemo;
                parseLinks(savedMemo);
            }
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            let html = '';
            checklist.forEach((item, idx) => {
                html += `
                <div class="flex items-center gap-3 py-2 border-b border-gray-100 last:border-0">
                    <div class="cursor-pointer ${item.checked ? 'text-muji-accent' : 'text-gray-300'}" onclick="toggleCheck(${idx})">
                        <i class="fa-solid ${item.checked ? 'fa-square-check' : 'fa-square'} text-xl"></i>
                    </div>
                    <span class="${item.checked ? 'line-through text-gray-300' : 'text-gray-700'} text-sm flex-1 transition-all">${item.text}</span>
                    <button onclick="removeCheck(${idx})" class="text-gray-200 hover:text-red-400 px-2"><i class="fa-solid fa-xmark"></i></button>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function toggleCheck(idx) {
            checklist[idx].checked = !checklist[idx].checked;
            saveChecklist();
        }

        function addCheckItem() {
            const input = document.getElementById('new-check-item');
            if(input.value.trim()) {
                checklist.push({ text: input.value, checked: false });
                input.value = '';
                saveChecklist();
            }
        }

        function removeCheck(idx) {
            checklist.splice(idx, 1);
            saveChecklist();
        }

        function saveChecklist() {
            localStorage.setItem('trip_checklist', JSON.stringify(checklist));
            renderChecklist();
        }

        function saveMemo() {
            const val = document.getElementById('memo-area').value;
            localStorage.setItem('trip_memo', val);
            parseLinks(val);
        }

        function parseLinks(text) {
            const container = document.getElementById('memo-links');
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            
            if(matches) {
                container.innerHTML = matches.map(url => `
                    <a href="${url}" target="_blank" class="text-xs bg-gray-100 text-blue-600 px-2 py-1 rounded truncate max-w-[150px] inline-block hover:bg-gray-200">
                        <i class="fa-solid fa-link"></i> ${url.replace(/https?:\/\//, '')}
                    </a>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

    </script>
</body>
</html>
