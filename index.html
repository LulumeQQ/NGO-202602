```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Companion App</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#D97706', // 琥珀色 (重點色)
                        secondary: '#F3F4F6', // 淺灰 (背景)
                        accent: '#78350F', // 深棕 (文字)
                        paper: '#FFFFFF', // 卡片白
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { -webkit-tap-highlight-color: transparent; }
        
        /* 頁面切換動畫 */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 底部導覽列選中狀態 */
        .nav-active { color: #D97706; }
        .nav-inactive { color: #9CA3AF; }
    </style>
</head>
<body class="bg-secondary text-gray-700 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-paper shadow-sm px-4 py-3 z-10 flex justify-between items-center shrink-0">
        <h1 class="text-xl font-bold text-accent tracking-widest">TRIP<span class="text-primary">2026</span></h1>
        <div id="header-status" class="text-xs font-medium bg-gray-100 px-2 py-1 rounded-full text-gray-500">
            東京・六天五夜
        </div>
    </header>

    <main id="main-container" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
        
        <section id="view-plan" class="view-section fade-in">
            <div class="bg-paper rounded-xl p-4 shadow-sm mb-6 border-l-4 border-primary">
                <h2 class="font-bold text-lg mb-2 text-accent"><i class="fa-solid fa-plane-departure mr-2"></i>航班資訊</h2>
                <div class="flex justify-between items-center text-sm mb-2">
                    <div>
                        <span class="block text-gray-400 text-xs">去程 (TPE -> NRT)</span>
                        <span class="font-bold text-lg">BR198</span>
                        <div class="text-primary font-medium">08:50 - 13:15</div>
                    </div>
                    <div class="text-center text-gray-300"><i class="fa-solid fa-arrow-right"></i></div>
                    <div class="text-right">
                        <span class="block text-gray-400 text-xs">回程 (NRT -> TPE)</span>
                        <span class="font-bold text-lg">BR197</span>
                        <div class="text-primary font-medium">14:15 - 17:00</div>
                    </div>
                </div>
                <div class="border-t border-gray-100 mt-2 pt-2">
                    <p class="text-xs text-gray-500"><i class="fa-solid fa-bed mr-1"></i>住宿：上野站前 APA Hotel (APA Hotel Ueno Ekimae)</p>
                    <p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-map-pin mr-1"></i>地址：東京都台東區上野 1-2-3</p>
                </div>
            </div>

            <div class="flex overflow-x-auto gap-2 mb-4 pb-2 no-scrollbar" id="day-tabs">
                </div>

            <div id="itinerary-list" class="space-y-4">
                </div>
        </section>

        <section id="view-guide" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold text-accent mb-4 border-b-2 border-primary inline-block pb-1">深度導覽</h2>
            
            <article class="bg-paper rounded-xl shadow-sm overflow-hidden mb-6">
                <div class="h-40 bg-gray-200 relative">
                    <img src="https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 bg-gradient-to-t from-black/70 to-transparent w-full p-3 pt-10">
                        <h3 class="text-white font-bold text-lg">淺草寺的秘密</h3>
                    </div>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-600 leading-relaxed mb-3">
                        你知道嗎？雷門的大燈籠重達 700 公斤！淺草寺創建於西元 628 年，是東京最古老的寺廟。求籤時如果抽到「凶」，記得要把籤詩綁在旁邊的架子上，象徵把壞運氣留在寺廟裡化解，不要帶回家喔。
                    </p>
                    <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=Sensoji+Temple')" class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> Google Maps
                    </button>
                </div>
            </article>

            <div class="bg-paper rounded-xl p-2 shadow-sm mb-6">
                 <h3 class="font-bold text-gray-800 mb-2 px-2">迪士尼樂園地圖</h3>
                 <iframe width="100%" height="300" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=139.8708%2C35.6256%2C139.8929%2C35.6378&amp;layer=mapnik" style="border-radius: 8px;"></iframe>
                 <small class="block text-right mt-1 text-gray-400 text-xs">OpenStreetMap View</small>
            </div>
        </section>

        <section id="view-wallet" class="view-section hidden fade-in">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 text-white shadow-lg mb-6 sticky top-0 z-20">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs text-gray-400">目前匯率 (JPY -> TWD)</label>
                    <input type="number" id="exchange-rate" value="0.22" class="bg-gray-700 text-white text-right w-16 text-xs p-1 rounded border-none focus:ring-1 focus:ring-primary" onchange="saveSettings()">
                </div>
                
                <div class="text-right mb-4">
                    <div class="text-3xl font-bold tracking-wider" id="display-jpy">¥0</div>
                    <div class="text-sm text-gray-400" id="display-twd">NT$0</div>
                </div>

                <div class="grid grid-cols-4 gap-2 mb-2">
                    <input type="text" id="expense-name" placeholder="品項名稱 (如: 拉麵)" class="col-span-4 bg-gray-700 border-none rounded p-2 text-white text-sm placeholder-gray-500">
                    
                    <div class="col-span-3 relative">
                         <input type="text" id="expense-calc" placeholder="金額或算式 (如: 500+200)" class="w-full bg-gray-700 border-none rounded p-2 text-white text-lg font-mono placeholder-gray-600">
                    </div>
                    
                    <label class="bg-gray-600 rounded flex items-center justify-center cursor-pointer active:bg-gray-500">
                        <i class="fa-solid fa-camera"></i>
                        <input type="file" id="expense-img" accept="image/*" capture="environment" class="hidden" onchange="handleImagePreview(this)">
                    </label>
                </div>
                
                <button onclick="addExpense()" class="w-full bg-primary py-2 rounded font-bold text-white hover:bg-amber-600 active:scale-95 transition shadow-lg shadow-orange-900/20">
                    <i class="fa-solid fa-plus mr-1"></i> 加入記帳
                </button>
                
                <div id="img-preview-area" class="hidden mt-2 relative inline-block">
                    <img id="img-preview" class="h-16 w-16 object-cover rounded border border-white/20">
                    <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="font-bold text-gray-700">消費紀錄</h3>
                <span class="text-xs text-gray-500" id="total-expense">總計: ¥0</span>
            </div>
            
            <div id="expense-list" class="space-y-3 pb-20">
                </div>
        </section>

        <section id="view-lists" class="view-section hidden fade-in">
            <div class="flex mb-4 bg-gray-200 rounded-lg p-1">
                <button onclick="switchListTab('check')" id="btn-tab-check" class="flex-1 py-1 text-sm rounded-md bg-white shadow text-primary font-bold transition">行前 Check</button>
                <button onclick="switchListTab('memo')" id="btn-tab-memo" class="flex-1 py-1 text-sm rounded-md text-gray-500 font-medium transition">備忘錄</button>
            </div>

            <div id="list-check-content">
                <div class="bg-paper rounded-xl p-4 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-primary pl-2">必備證件</h3>
                    <ul class="space-y-2" id="checklist-docs">
                        </ul>
                </div>
                <div class="bg-paper rounded-xl p-4 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-gray-400 pl-2">生活用品</h3>
                    <ul class="space-y-2" id="checklist-items">
                         </ul>
                </div>
            </div>

            <div id="list-memo-content" class="hidden h-full flex flex-col">
                <textarea id="memo-pad" class="w-full flex-1 bg-paper rounded-xl p-4 shadow-sm border-none resize-none focus:ring-2 focus:ring-primary text-gray-700 leading-relaxed" placeholder="在這裡輸入筆記、網址... (輸入網址會自動變成連結)"></textarea>
                <div class="text-xs text-gray-400 mt-2 text-center">自動儲存中...</div>
                
                <div id="memo-links" class="mt-4 space-y-2"></div>
            </div>
        </section>

        <section id="view-info" class="view-section hidden fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 px-2">實用資訊</h2>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100 active:bg-blue-100">
                    <i class="fa-solid fa-cloud-sun text-2xl text-blue-500 mb-2"></i>
                    <div class="text-sm font-bold text-blue-800">天氣預報</div>
                    <div class="text-xs text-blue-400">日本氣象廳</div>
                </a>
                 <a href="https://www.google.com/maps/search/police" target="_blank" class="bg-red-50 p-4 rounded-xl text-center border border-red-100 active:bg-red-100">
                    <i class="fa-solid fa-shield-halved text-2xl text-red-500 mb-2"></i>
                    <div class="text-sm font-bold text-red-800">緊急求助</div>
                    <div class="text-xs text-red-400">警察 (110)</div>
                </a>
            </div>

            <div class="bg-paper rounded-xl p-5 shadow-sm space-y-4">
                <div class="flex items-start">
                    <i class="fa-solid fa-triangle-exclamation text-amber-500 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-bold text-gray-800">旅遊禁忌</h4>
                        <p class="text-sm text-gray-600 mt-1">日本電車內請將手機設為靜音，避免通話。搭乘手扶梯時東京靠左站立（大阪靠右）。</p>
                    </div>
                </div>
                <hr class="border-gray-100">
                 <div class="flex items-start">
                    <i class="fa-solid fa-passport text-blue-500 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-bold text-gray-800">遺失護照</h4>
                        <p class="text-sm text-gray-600 mt-1">台北駐日經濟文化代表處<br>電話：03-3280-7811<br>地址：東京都港區白金台 5-20-2</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <nav class="bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] h-20 pb-4 pt-2 px-2 flex justify-around items-center shrink-0 z-50">
        <button onclick="switchView('plan')" class="nav-btn w-16 text-center group" data-target="plan">
            <div class="text-xl mb-1 group-active:scale-90 transition"><i class="fa-solid fa-calendar-days"></i></div>
            <div class="text-[10px] font-medium">行程</div>
        </button>
        <button onclick="switchView('guide')" class="nav-btn w-16 text-center group" data-target="guide">
            <div class="text-xl mb-1 group-active:scale-90 transition"><i class="fa-solid fa-book-open"></i></div>
            <div class="text-[10px] font-medium">導覽</div>
        </button>
        <button onclick="switchView('wallet')" class="nav-btn w-16 text-center group" data-target="wallet">
            <div class="h-12 w-12 bg-primary text-white rounded-full flex items-center justify-center text-xl shadow-lg -mt-6 mx-auto group-active:translate-y-1 transition">
                <i class="fa-solid fa-calculator"></i>
            </div>
            <div class="text-[10px] font-medium mt-1">記帳</div>
        </button>
        <button onclick="switchView('lists')" class="nav-btn w-16 text-center group" data-target="lists">
            <div class="text-xl mb-1 group-active:scale-90 transition"><i class="fa-solid fa-list-check"></i></div>
            <div class="text-[10px] font-medium">清單</div>
        </button>
        <button onclick="switchView('info')" class="nav-btn w-16 text-center group" data-target="info">
            <div class="text-xl mb-1 group-active:scale-90 transition"><i class="fa-solid fa-circle-info"></i></div>
            <div class="text-[10px] font-medium">資訊</div>
        </button>
    </nav>

    <script>
        // ========================= DATA CONFIG (在此修改行程資料) =========================
        
        // 行程資料 (可以根據您的需求修改文字、時間、顏色)
        // type: 'move' (交通), 'food' (餐廳), 'spot' (景點), 'hotel' (住宿)
        // highlight: true (會用重點色標示)
        const itineraryData = {
            "D1": [
                { time: "06:30", title: "桃園機場集合", desc: "第二航廈 長榮櫃台", type: "move", highlight: true },
                { time: "08:50", title: "起飛 BR198", desc: "飛往東京成田", type: "move" },
                { time: "14:30", title: "抵達市區 & Check-in", desc: "搭乘 Skyliner 直達上野", type: "hotel" },
                { time: "16:00", title: "阿美橫丁逛街", desc: "藥妝採買、二木菓子", type: "spot" },
                { time: "19:00", title: "晚餐：一蘭拉麵", desc: "上野山下口店", type: "food", link: "https://goo.gl/maps/xyz" }
            ],
            "D2": [
                { time: "09:00", title: "淺草寺參拜", desc: "雷門拍照、抽籤", type: "spot" },
                { time: "12:00", title: "晴空塔", desc: "敘敘苑燒肉午餐 (已預約)", type: "food", highlight: true },
                { time: "15:00", title: "澀谷 Sky", desc: "絕美日落展望台", type: "spot" }
            ],
            "D3": [
                { time: "08:00", title: "迪士尼樂園", desc: "全日遊玩，記得抽 DPA", type: "spot", highlight: true, link: "https://www.tokyodisneyresort.jp/tc/tdl/" }
            ],
            "D4": [
                { time: "10:00", title: "築地市場", desc: "吃玉子燒、生魚片", type: "food" },
                { time: "14:00", title: "銀座逛街", desc: "步行者天國 (週末限定)", type: "spot" }
            ],
            "D5": [
                { time: "10:00", title: "明治神宮", desc: "散步吸芬多精", type: "spot" },
                { time: "13:00", title: "原宿竹下通", desc: "吃可麗餅", type: "food" }
            ],
            "D6": [
                { time: "11:00", title: "退房 & 前往機場", desc: "最後補貨", type: "move" },
                { time: "14:15", title: "回程 BR197", desc: "平安回家", type: "move", highlight: true }
            ]
        };

        const checklistData = {
            docs: ["護照 (有效期限6個月以上)", "Visit Japan Web截圖", "網卡/漫遊開通", "信用卡 (建議2-3張)", "日幣現金"],
            items: ["行動電源", "充電線/轉接頭", "常備藥品 (胃藥/止痛)", "個人盥洗用品", "環保袋 (購物用)"]
        };

        // ========================= APP LOGIC =========================

        // 1. View Switching
        function switchView(viewName) {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Show target
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewName) {
                    btn.classList.add('nav-active');
                    btn.classList.remove('nav-inactive');
                } else {
                    btn.classList.remove('nav-active');
                    btn.classList.add('nav-inactive');
                }
            });

            // Special triggers
            if(viewName === 'wallet') renderExpenses();
            if(viewName === 'lists') renderMemoLinks();
        }

        // 2. Plan / Itinerary Logic
        let currentDay = "D1";

        function renderPlan() {
            // Render Day Tabs
            const tabsContainer = document.getElementById('day-tabs');
            tabsContainer.innerHTML = Object.keys(itineraryData).map(day => `
                <button onclick="setDay('${day}')" 
                    class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition ${currentDay === day ? 'bg-primary text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100'}">
                    ${day}
                </button>
            `).join('');

            // Render Timeline
            const listContainer = document.getElementById('itinerary-list');
            const items = itineraryData[currentDay] || [];
            
            listContainer.innerHTML = items.map((item, index) => {
                const isLast = index === items.length - 1;
                const iconMap = {
                    move: 'fa-van-shuttle',
                    food: 'fa-utensils',
                    spot: 'fa-camera',
                    hotel: 'fa-bed'
                };
                const icon = iconMap[item.type] || 'fa-circle';
                
                return `
                <div class="flex gap-4">
                    <div class="flex flex-col items-center w-12 shrink-0">
                        <div class="text-xs font-bold text-gray-400 mb-1">${item.time}</div>
                        <div class="w-8 h-8 rounded-full flex items-center justify-center z-10 ${item.highlight ? 'bg-primary text-white shadow-lg shadow-orange-200' : 'bg-white border-2 border-gray-200 text-gray-400'}">
                            <i class="fa-solid ${icon} text-xs"></i>
                        </div>
                        ${!isLast ? '<div class="w-0.5 flex-1 bg-gray-200 my-1"></div>' : ''}
                    </div>
                    <div class="flex-1 pb-6">
                        <div class="bg-paper rounded-lg p-3 shadow-sm ${item.highlight ? 'border-l-4 border-primary' : ''}">
                            <div class="font-bold text-gray-800 text-base">${item.title}</div>
                            <div class="text-sm text-gray-500 mt-1">${item.desc}</div>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="inline-block mt-2 text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"><i class="fa-solid fa-link mr-1"></i>查看詳情</a>` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function setDay(day) {
            currentDay = day;
            renderPlan();
        }

        // 3. Wallet Logic
        let expenses = JSON.parse(localStorage.getItem('travel_expenses')) || [];
        let tempImgBase64 = null;

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            let totalJPY = 0;

            list.innerHTML = expenses.map((ex, idx) => {
                totalJPY += ex.amount;
                return `
                <div class="bg-paper p-3 rounded-lg shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3 overflow-hidden">
                        ${ex.img ? `<div onclick="showImage('${ex.img}')" class="w-10 h-10 rounded bg-cover bg-center shrink-0 cursor-pointer border border-gray-100" style="background-image:url('${ex.img}')"></div>` : `<div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-gray-400 shrink-0"><i class="fa-solid fa-receipt"></i></div>`}
                        <div class="min-w-0">
                            <div class="font-bold text-gray-800 truncate text-sm">${ex.name}</div>
                            <div class="text-xs text-gray-400">${new Date(ex.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="text-right shrink-0">
                        <div class="font-bold text-gray-800">¥${ex.amount.toLocaleString()}</div>
                        <div class="text-xs text-gray-400">≈ $${Math.round(ex.amount * rate).toLocaleString()}</div>
                    </div>
                    <button onclick="deleteExpense(${idx})" class="ml-2 text-gray-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
                `;
            }).join('');
            
            if(expenses.length === 0) list.innerHTML = `<div class="text-center text-gray-400 mt-10 text-sm">還沒有記帳紀錄</div>`;

            document.getElementById('total-expense').innerText = `總計: ¥${totalJPY.toLocaleString()} (約 NT$${Math.round(totalJPY*rate).toLocaleString()})`;
        }

        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const calcInput = document.getElementById('expense-calc').value;
            
            if(!name || !calcInput) return alert('請輸入名稱和金額');

            try {
                // 安全的計算算式 (例如 500+200)
                // 只允許數字和 + - * / . ()
                if(/[^0-9+\-*/.()]/.test(calcInput)) throw new Error("無效字元");
                const amount = new Function('return ' + calcInput)();
                
                expenses.unshift({
                    name,
                    amount: Math.round(amount),
                    date: new Date().toISOString(),
                    img: tempImgBase64
                });

                localStorage.setItem('travel_expenses', JSON.stringify(expenses));
                
                // Reset form
                document.getElementById('expense-name').value = '';
                document.getElementById('expense-calc').value = '';
                clearImage();
                renderExpenses();

            } catch(e) {
                alert('金額格式錯誤，請輸入數字或簡單算式 (如 100+50)');
            }
        }

        function deleteExpense(index) {
            if(confirm('確定刪除此筆紀錄？')) {
                expenses.splice(index, 1);
                localStorage.setItem('travel_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }

        function showImage(base64) {
            const win = window.open("");
            win.document.write(`<img src="${base64}" style="width:100%">`);
        }

        // Image Handling with Canvas Compression
        function handleImagePreview(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Canvas Compress
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize Logic (Max 600px)
                        const MAX_SIZE = 600;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Output Base64 (JPEG quality 0.7)
                        tempImgBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // UI Update
                        document.getElementById('img-preview').src = tempImgBase64;
                        document.getElementById('img-preview-area').classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('img-preview-area').classList.add('hidden');
            document.getElementById('expense-img').value = '';
            tempImgBase64 = null;
        }

        // Live Calculator for Wallet Display
        document.getElementById('expense-calc').addEventListener('keyup', function(e) {
            try {
                if(/[^0-9+\-*/.()]/.test(this.value)) return;
                const val = new Function('return ' + this.value)();
                const rate = parseFloat(document.getElementById('exchange-rate').value);
                if(!isNaN(val)) {
                    document.getElementById('display-jpy').innerText = '¥' + Math.round(val).toLocaleString();
                    document.getElementById('display-twd').innerText = 'NT$' + Math.round(val * rate).toLocaleString();
                }
            } catch(e) {}
        });

        // 4. List Logic
        function switchListTab(tab) {
            if(tab === 'check') {
                document.getElementById('list-check-content').classList.remove('hidden');
                document.getElementById('list-memo-content').classList.add('hidden');
                document.getElementById('btn-tab-check').className = "flex-1 py-1 text-sm rounded-md bg-white shadow text-primary font-bold transition";
                document.getElementById('btn-tab-memo').className = "flex-1 py-1 text-sm rounded-md text-gray-500 font-medium transition";
            } else {
                document.getElementById('list-check-content').classList.add('hidden');
                document.getElementById('list-memo-content').classList.remove('hidden');
                document.getElementById('btn-tab-check').className = "flex-1 py-1 text-sm rounded-md text-gray-500 font-medium transition";
                document.getElementById('btn-tab-memo').className = "flex-1 py-1 text-sm rounded-md bg-white shadow text-primary font-bold transition";
            }
        }

        // Checklist Rendering & Persistence
        let checkState = JSON.parse(localStorage.getItem('travel_checklist')) || {};

        function renderChecklist() {
            const renderGroup = (items, idPrefix) => items.map((item, idx) => {
                const key = idPrefix + idx;
                const isChecked = checkState[key];
                return `
                <li class="flex items-center group cursor-pointer" onclick="toggleCheck('${key}')">
                    <div class="w-5 h-5 rounded border border-gray-300 mr-3 flex items-center justify-center transition ${isChecked ? 'bg-primary border-primary' : 'bg-white'}">
                        ${isChecked ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}
                    </div>
                    <span class="${isChecked ? 'text-gray-400 line-through' : 'text-gray-700'}">${item}</span>
                </li>`;
            }).join('');

            document.getElementById('checklist-docs').innerHTML = renderGroup(checklistData.docs, 'd_');
            document.getElementById('checklist-items').innerHTML = renderGroup(checklistData.items, 'i_');
        }

        function toggleCheck(key) {
            checkState[key] = !checkState[key];
            localStorage.setItem('travel_checklist', JSON.stringify(checkState));
            renderChecklist();
        }

        // Memo Logic
        const memoPad = document.getElementById('memo-pad');
        memoPad.value = localStorage.getItem('travel_memo') || '';
        
        memoPad.addEventListener('input', () => {
            localStorage.setItem('travel_memo', memoPad.value);
            renderMemoLinks();
        });

        function renderMemoLinks() {
            const text = memoPad.value;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            
            const container = document.getElementById('memo-links');
            if(matches && matches.length > 0) {
                container.innerHTML = matches.map(url => `
                    <a href="${url}" target="_blank" class="block w-full bg-blue-50 text-blue-600 px-3 py-2 rounded text-sm truncate hover:bg-blue-100 mb-1">
                        <i class="fa-solid fa-link mr-2"></i>${url}
                    </a>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

        // Initialization
        window.onload = function() {
            // Load Exchange Rate
            const savedRate = localStorage.getItem('travel_rate');
            if(savedRate) document.getElementById('exchange-rate').value = savedRate;

            renderPlan();
            renderChecklist();
            switchView('plan'); // Default View
        };
        
        function saveSettings() {
             localStorage.setItem('travel_rate', document.getElementById('exchange-rate').value);
        }

    </script>
</body>
</html>

```