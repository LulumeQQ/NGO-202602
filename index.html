<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹æ»‘é›ªä¹‹æ—…</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#fdfbf7',     /* æº«æš–ç±³ç™½ */
                        'muji-text': '#44403c',   /* æ·±ç° */
                        'cat-orange': '#f97316',  /* æ©˜è²“è‰² */
                        'cat-soft': '#ffedd5',    /* æ·ºæ©˜èƒŒæ™¯ */
                        'card-white': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 12px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            color: #44403c;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* è¡Œç¨‹é¸å–ç‰¹æ•ˆ */
        .trip-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        .trip-card.active {
            border-color: #f97316;
            background-color: #fff7ed; /* orange-50 */
            transform: scale(1.01);
        }
        /* è²“æŒå°ç«  */
        .paw-stamp {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 2rem;
            color: #f97316;
            opacity: 0;
            transform: scale(0.5) rotate(-20deg);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        .trip-card.active .paw-stamp {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        /* æ™‚é–“è»¸æ©˜è‰²é»é» */
        .timeline-dot {
            transition: background-color 0.3s;
        }
        .trip-card.active ~ .timeline-dot, 
        .trip-card.active + .timeline-container .timeline-dot {
            background-color: #f97316 !important;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .muji-input {
            width: 100%;
            background: #f5f5f4;
            border: none;
            border-radius: 12px;
            padding: 12px;
            outline: none;
            transition: ring 0.2s;
        }
        .muji-input:focus {
            box-shadow: 0 0 0 2px #f97316;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-card-white shadow-sm px-6 py-4 z-20 flex justify-between items-center relative shrink-0">
        <div>
            <h1 class="text-xl font-black text-muji-text tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-person-skiing text-cat-orange"></i>
                åå¤å±‹æ»‘é›ªä¹‹æ—…
            </h1>
            <p class="text-xs text-gray-400 font-bold mt-1 tracking-widest">2026.02.06 - 02.14</p>
        </div>
        <div class="w-10 h-10 bg-cat-soft rounded-full flex items-center justify-center text-cat-orange shadow-sm">
            <i class="fa-solid fa-cat text-lg"></i>
        </div>
    </header>

    <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar pb-24 relative bg-muji-bg scroll-smooth">
        </main>

    <nav class="bg-card-white/95 backdrop-blur-md border-t border-gray-100 fixed bottom-0 w-full pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="router('plan')" class="nav-btn group flex flex-col items-center w-full" id="btn-plan">
                <div class="nav-icon text-xl mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-calendar-days"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">è¡Œç¨‹</span>
            </button>
            <button onclick="router('guide')" class="nav-btn group flex flex-col items-center w-full" id="btn-guide">
                <div class="nav-icon text-xl mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-book-open"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">å°è¦½</span>
            </button>
            <button onclick="router('wallet')" class="nav-btn group flex flex-col items-center w-full" id="btn-wallet">
                <div class="nav-icon text-xl mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-wallet"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">è¨˜å¸³</span>
            </button>
            <button onclick="router('lists')" class="nav-btn group flex flex-col items-center w-full" id="btn-lists">
                <div class="nav-icon text-xl mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-clipboard-check"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">æ¸…å–®</span>
            </button>
            <button onclick="router('info')" class="nav-btn group flex flex-col items-center w-full" id="btn-info">
                <div class="nav-icon text-xl mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-circle-info"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <div id="img-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex justify-center items-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <img id="img-modal-src" src="" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl">
    </div>

    <script>
        // --- Data ---
        const tripData = {
            flights: [
                { type: 'å»ç¨‹', date: '02/06', code: 'CI 0154', route: 'TPE 07:35 â NGO 11:05' },
                { type: 'å›ç¨‹', date: '02/14', code: 'CI 0151', route: 'NGO 09:50 â TPE 12:15' }
            ],
            itinerary: {
                d1: [
                    { id: 'd1-1', time: '03:30', title: 'æ©Ÿå ´æ¥é€', desc: 'å®¶è£¡ -> æ¡ƒåœ’æ©Ÿå ´', type: 'transport', highlight: true },
                    { id: 'd1-2', time: '07:35', title: 'é£›å¾€åå¤å±‹', desc: 'CI 0154', type: 'flight' },
                    { id: 'd1-3', time: '11:05', title: 'æŠµé”åå¤å±‹', desc: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´', type: 'arrival' },
                    { id: 'd1-4', time: '12:00', title: 'å–è»Š', desc: 'Centrair, 1-chÅmeâˆ’1', type: 'car', addr: 'ã€’479-0881 Aichi, Tokoname, Centrair, 1-chÅmeâˆ’1 1 ç¬¬ä¸€, æ—¥æœ¬' },
                    { id: 'd1-5', time: '13:30', title: 'JR Gate Tower Mall', desc: 'ä¸­é¤èˆ‡é€› Bic Camera', type: 'food', addr: '1-1-4 Meieki, Nakamura-ku, Nagoya-shi, Aichi 450-6001' },
                    { id: 'd1-6', time: '16:00', title: 'å‰å¾€ä½å®¿', desc: 'éˆ´é¹¿è³½è»Šæ¨‚åœ’é…’åº—', type: 'hotel', addr: '7992 Inoucho, Suzuka, Mie 510-0201æ—¥æœ¬' }
                ],
                d2: [
                    { id: 'd2-1', time: '09:00', title: 'éˆ´é¹¿è³½è»Šæ¨‚åœ’', desc: 'ç©åˆ°æ™šä¸Š 17:00', type: 'play', highlight: true },
                    { id: 'd2-2', time: '18:30', title: 'å‰å¾€ Airbnb', desc: 'åå¤å±‹å¸‚ç·‘å€', type: 'hotel', addr: 'æ„›çŸ¥ç¸£åå¤å±‹å¸‚ç·‘å€é³´æµ·ç”ºå­—ä½œç”º26è™Ÿ' }
                ]
            },
            checklist: ['è­·ç…§', 'ç¶²å¡/æ¼«éŠ', 'æ—¥å¹£ç¾é‡‘', 'ä¿¡ç”¨å¡', 'é§•ç…§æ—¥æ–‡è­¯æœ¬', 'è¡Œå‹•é›»æº', 'ä¿æš–è¡£ç‰©', 'å€‹äººè—¥å“']
        };

        // --- State Management ---
        let currentDay = 'd1';
        let walletRate = parseFloat(localStorage.getItem('trip_rate')) || 0.22;
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
        let checklistState = JSON.parse(localStorage.getItem('trip_checklist')) || {};
        let memoContent = localStorage.getItem('trip_memo') || '';

        // --- Icons Mapping ---
        const icons = {
            transport: 'fa-car-side',
            flight: 'fa-plane-departure',
            arrival: 'fa-plane-arrival',
            car: 'fa-key',
            food: 'fa-utensils',
            hotel: 'fa-bed',
            play: 'fa-ticket'
        };

        // --- Core Functions ---
        function init() {
            router('plan');
        }

        function router(page) {
            // Update Nav Styles
            document.querySelectorAll('.nav-btn .nav-icon').forEach(el => el.classList.replace('text-cat-orange', 'text-gray-400'));
            const btn = document.getElementById('btn-' + page);
            if(btn) btn.querySelector('.nav-icon').classList.replace('text-gray-400', 'text-cat-orange');

            const content = document.getElementById('app-content');
            content.innerHTML = ''; // Clear
            content.scrollTop = 0;

            // Render Page
            switch(page) {
                case 'plan': renderPlan(content); break;
                case 'guide': renderGuide(content); break;
                case 'wallet': renderWallet(content); break;
                case 'lists': renderLists(content); break;
                case 'info': renderInfo(content); break;
            }
        }

        // --- 1. PLAN MODULE ---
        function renderPlan(container) {
            // Flight Card
            let flightHTML = `<div class="p-4 space-y-3">
                <div class="bg-white p-4 rounded-2xl shadow-soft">
                    <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Flight Info</h3>
                    ${tripData.flights.map(f => `
                        <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0">
                            <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">${f.type}</span>
                            <span class="text-sm font-bold text-muji-text">${f.code}</span>
                            <span class="text-xs text-gray-500">${f.route}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;

            // Day Switcher
            let switcherHTML = `
            <div class="flex px-4 gap-2 mb-4 sticky top-0 z-10 py-2 bg-muji-bg/95 backdrop-blur">
                <button onclick="switchDay('d1')" id="btn-d1" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all shadow-sm ${currentDay === 'd1' ? 'bg-cat-orange text-white' : 'bg-white text-gray-400'}">Day 1 (2/06)</button>
                <button onclick="switchDay('d2')" id="btn-d2" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all shadow-sm ${currentDay === 'd2' ? 'bg-cat-orange text-white' : 'bg-white text-gray-400'}">Day 2 (2/07)</button>
            </div>
            `;

            // Timeline
            let timelineHTML = `<div id="timeline-list" class="px-4 pb-8 space-y-4">
                ${renderDayItems(currentDay)}
            </div>`;

            container.innerHTML = flightHTML + switcherHTML + timelineHTML;
            checkSelection();
        }

        function switchDay(day) {
            currentDay = day;
            document.getElementById('btn-d1').className = `flex-1 py-2 rounded-xl text-sm font-bold transition-all shadow-sm ${day === 'd1' ? 'bg-cat-orange text-white' : 'bg-white text-gray-400'}`;
            document.getElementById('btn-d2').className = `flex-1 py-2 rounded-xl text-sm font-bold transition-all shadow-sm ${day === 'd2' ? 'bg-cat-orange text-white' : 'bg-white text-gray-400'}`;
            document.getElementById('timeline-list').innerHTML = renderDayItems(day);
            checkSelection();
        }

        function renderDayItems(day) {
            return tripData.itinerary[day].map((item, index) => {
                const iconClass = icons[item.type] || 'fa-location-dot';
                const highlightClass = item.highlight ? 'text-cat-orange' : 'text-gray-400';
                const mapBtn = item.addr ? 
                    `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.addr)}" target="_blank" class="mt-2 inline-flex items-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg transition-colors" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-map-location-dot mr-1.5 text-cat-orange"></i> å°èˆªå»
                    </a>` : '';

                return `
                <div class="flex gap-4 group" onclick="toggleSelection('${item.id}')">
                    <div class="flex flex-col items-center min-w-[3.5rem] pt-2">
                        <span class="text-sm font-bold font-mono text-gray-500 mb-1">${item.time}</span>
                        <div class="w-3 h-3 rounded-full bg-gray-200 border-2 border-white shadow-sm z-10 timeline-dot" id="dot-${item.id}"></div>
                        ${index !== tripData.itinerary[day].length - 1 ? '<div class="w-0.5 flex-1 bg-gray-200 my-1"></div>' : ''}
                    </div>
                    
                    <div class="flex-1 pb-4">
                        <div id="card-${item.id}" class="trip-card bg-white p-4 rounded-2xl shadow-soft relative overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg text-muji-text ${item.highlight ? 'text-cat-orange' : ''}">${item.title}</h4>
                                    <p class="text-sm text-gray-500 mt-1 leading-relaxed">${item.desc}</p>
                                </div>
                                <i class="fa-solid ${iconClass} ${highlightClass} opacity-20 text-3xl absolute top-3 right-3"></i>
                            </div>
                            ${mapBtn}
                            <i class="fa-solid fa-paw paw-stamp"></i>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleSelection(id) {
            // Remove active from all
            document.querySelectorAll('.trip-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.timeline-dot').forEach(el => el.classList.remove('bg-cat-orange'));
            
            // Add to current
            const card = document.getElementById(`card-${id}`);
            const dot = document.getElementById(`dot-${id}`);
            if(card) card.classList.add('active');
            if(dot) dot.classList.add('bg-cat-orange');
            
            localStorage.setItem('trip_current_selection', id);
        }

        function checkSelection() {
            const savedId = localStorage.getItem('trip_current_selection');
            if(savedId && document.getElementById(`card-${savedId}`)) {
                toggleSelection(savedId);
            }
        }

        // --- 2. GUIDE MODULE ---
        function renderGuide(container) {
            container.innerHTML = `
            <div class="p-6">
                <div class="bg-white rounded-3xl overflow-hidden shadow-soft mb-8">
                    <div class="h-40 bg-gray-200 relative overflow-hidden">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-6">
                            <h2 class="text-2xl font-black text-white">éˆ´é¹¿è³½è»Šæ¨‚åœ’</h2>
                         </div>
                    </div>
                    <div class="p-6">
                        <span class="text-xs font-bold text-cat-orange bg-orange-50 px-2 py-1 rounded mb-3 inline-block">å¿…è¨ªæ™¯é»</span>
                        <p class="text-sm text-gray-600 leading-7 text-justify">
                            æ—¥æœ¬è‘—åçš„è³½è»Šå ´ï¼Œä¹Ÿæ˜¯ F1 æ—¥æœ¬å¤§çè³½çš„èˆ‰è¾¦åœ°ã€‚é€™è£¡ä¸åƒ…æœ‰å°ˆæ¥­è³½é“ï¼Œæ›´æ˜¯ä¸€å€‹ä»¥ã€Œäº¤é€šå·¥å…·ã€ç‚ºä¸»é¡Œçš„éŠæ¨‚åœ’ã€‚
                            <br><br>
                            <strong class="text-muji-text">æ¨è–¦é‡é»ï¼š</strong><br>
                            1. æŒ‘æˆ°åªæœ‰é€™è£¡æ‰æœ‰çš„ã€ŒCircuit Challengerã€é›»å‹•è³½è»Šã€‚<br>
                            2. æ‘©å¤©è¼ªå¯ä»¥ä¿¯ç°æ•´å€‹ä¼Šå‹¢ç£èˆ‡è³½é“å…¨æ™¯ã€‚
                        </p>
                    </div>
                </div>

                <div class="bg-white rounded-3xl overflow-hidden shadow-soft">
                    <div class="h-40 bg-gray-200 relative overflow-hidden">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-6">
                            <h2 class="text-2xl font-black text-white">åå¤å±‹ç¾é£Ÿ</h2>
                         </div>
                    </div>
                    <div class="p-6">
                        <span class="text-xs font-bold text-cat-orange bg-orange-50 px-2 py-1 rounded mb-3 inline-block">é£Ÿæ–‡åŒ–</span>
                        <p class="text-sm text-gray-600 leading-7 text-justify">
                            åå¤å±‹çš„é£²é£Ÿæ–‡åŒ–è¢«ç¨±ç‚ºã€Œåå¤å±‹ã‚ã—ã€ï¼Œå£å‘³åé‡ï¼Œç‰¹è‰²é®®æ˜ã€‚
                            <br><br>
                            <strong class="text-muji-text">å¿…åƒæ¸…å–®ï¼š</strong><br>
                            ğŸ² <span class="font-bold">å‘³å™Œè±¬æ’</span> (çŸ¢å ´æ•¦)<br>
                            ğŸœ <span class="font-bold">æ£Šå­éºµ</span> (æ‰å¹³çƒé¾éºµ)<br>
                            ğŸ¥– <span class="font-bold">å°å€‰ç´…è±†åå¸</span> (æ—©é¤å¿…é»)
                        </p>
                    </div>
                </div>
            </div>`;
        }

        // --- 3. WALLET MODULE ---
        function renderWallet(container) {
            // Calculate Totals
            const totalYen = expenses.reduce((sum, item) => sum + item.amount, 0);
            const totalTwd = Math.round(totalYen * walletRate);

            container.innerHTML = `
            <div class="p-4 space-y-6">
                <div class="bg-cat-orange text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                    <i class="fa-solid fa-cat absolute -right-4 -bottom-4 text-8xl opacity-20 transform rotate-12"></i>
                    
                    <div class="mb-4">
                        <label class="text-xs opacity-80 block mb-1">åŒ¯ç‡è¨­å®š (1 JPY = ? TWD)</label>
                        <input type="number" step="0.001" value="${walletRate}" onchange="updateRate(this.value)" class="bg-white/20 text-white w-24 text-center rounded px-2 py-1 outline-none font-mono">
                    </div>

                    <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm">
                        <div class="flex gap-2">
                            <input type="text" id="calc-input" placeholder="è¼¸å…¥ç®—å¼ (å¦‚ 500+200*3)" class="flex-1 bg-transparent text-white placeholder-white/50 outline-none font-mono text-lg">
                            <button onclick="calculate()" class="text-white font-bold"><i class="fa-solid fa-equals"></i></button>
                        </div>
                        <div id="calc-result" class="text-right text-2xl font-bold mt-2 h-8">0</div>
                        <div id="calc-twd" class="text-right text-sm opacity-80 h-5">NT$ 0</div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-soft">
                    <h3 class="font-bold text-muji-text mb-4">æ–°å¢è¨˜å¸³</h3>
                    <div class="space-y-3">
                        <input type="text" id="exp-name" placeholder="å“é …åç¨±" class="muji-input">
                        <input type="number" id="exp-amount" placeholder="é‡‘é¡ (æ—¥å¹£)" class="muji-input">
                        
                        <div class="flex items-center gap-3">
                            <label class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl text-center cursor-pointer hover:bg-gray-200 transition-colors">
                                <i class="fa-solid fa-camera mr-2"></i>æ‹ç…§/ä¸Šå‚³
                                <input type="file" id="exp-img" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this)">
                            </label>
                            <button onclick="addExpense()" class="bg-cat-orange text-white px-6 py-3 rounded-xl shadow-lg shadow-orange-200 font-bold">å„²å­˜</button>
                        </div>
                        <div id="preview-area" class="hidden mt-2">
                            <img id="img-preview" class="h-20 rounded-lg object-cover border border-gray-200">
                        </div>
                    </div>
                </div>

                <div class="pb-safe">
                    <div class="flex justify-between items-end mb-2 px-2">
                        <h3 class="font-bold text-muji-text">æ¶ˆè²»ç´€éŒ„</h3>
                        <span class="text-xs text-gray-400">ç¸½è¨ˆ Â¥${totalYen.toLocaleString()} (ç´„ NT$${totalTwd.toLocaleString()})</span>
                    </div>
                    <div class="space-y-3" id="expense-list">
                        ${expenses.slice().reverse().map((item, idx) => `
                            <div class="bg-white p-3 rounded-2xl shadow-sm flex items-center gap-3">
                                ${item.img ? `<img src="${item.img}" class="w-12 h-12 rounded-lg object-cover bg-gray-100 cursor-pointer" onclick="showFullImage('${item.img}')">` : '<div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-300"><i class="fa-solid fa-receipt"></i></div>'}
                                <div class="flex-1">
                                    <div class="font-bold text-muji-text">${item.name}</div>
                                    <div class="text-xs text-gray-400">${item.date}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono font-bold text-muji-text">Â¥${item.amount}</div>
                                    <div class="text-[10px] text-gray-400">NT$${Math.round(item.amount * walletRate)}</div>
                                </div>
                                <button onclick="deleteExpense(${expenses.length - 1 - idx})" class="text-gray-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }

        // Wallet Logic
        function updateRate(val) {
            walletRate = parseFloat(val);
            localStorage.setItem('trip_rate', walletRate);
            renderWallet(document.getElementById('app-content'));
        }

        function calculate() {
            const input = document.getElementById('calc-input').value;
            try {
                // Warning: eval is dangerous in general web apps, but safe for a local static tool like this
                const res = eval(input.replace(/[^-()\d/*+.]/g, '')); 
                document.getElementById('calc-result').innerText = 'Â¥ ' + res.toLocaleString();
                document.getElementById('calc-twd').innerText = 'â‰ˆ NT$ ' + Math.round(res * walletRate).toLocaleString();
            } catch(e) {
                document.getElementById('calc-result').innerText = 'Error';
            }
        }

        let tempImgBase64 = null;
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Canvas Compress
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800; 
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        tempImgBase64 = canvas.toDataURL('image/jpeg', 0.7); // Compress
                        
                        // Show Preview
                        const pArea = document.getElementById('preview-area');
                        const pImg = document.getElementById('img-preview');
                        pArea.classList.remove('hidden');
                        pImg.src = tempImgBase64;
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addExpense() {
            const name = document.getElementById('exp-name').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            
            if(!name || !amount) { alert('è«‹è¼¸å…¥åç¨±èˆ‡é‡‘é¡'); return; }

            const newExp = {
                name, 
                amount,
                img: tempImgBase64,
                date: new Date().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})
            };

            expenses.push(newExp);
            localStorage.setItem('trip_expenses', JSON.stringify(expenses));
            
            // Reset
            tempImgBase64 = null;
            renderWallet(document.getElementById('app-content'));
        }

        function deleteExpense(originalIdx) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
                expenses.splice(originalIdx, 1);
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
                renderWallet(document.getElementById('app-content'));
            }
        }

        function showFullImage(src) {
            document.getElementById('img-modal-src').src = src;
            document.getElementById('img-modal').classList.remove('hidden');
        }

        // --- 4. LISTS MODULE ---
        function renderLists(container) {
            // Links regex
            const linkify = (text) => {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, function(url) {
                    return `<a href="${url}" target="_blank" class="text-cat-orange underline font-bold"><i class="fa-solid fa-link mr-1"></i>é€£çµ</a>`;
                })
            };

            container.innerHTML = `
            <div class="p-4 space-y-6">
                <div class="bg-white rounded-3xl p-5 shadow-soft">
                    <h3 class="font-bold text-muji-text mb-4 border-l-4 border-cat-orange pl-3">è¡Œå‰æº–å‚™</h3>
                    <div class="grid grid-cols-1 gap-3">
                        ${tripData.checklist.map(item => `
                            <label class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                                <div class="relative flex items-center">
                                    <input type="checkbox" onchange="toggleCheck('${item}')" ${checklistState[item] ? 'checked' : ''} class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-gray-300 transition-all checked:border-cat-orange checked:bg-cat-orange">
                                    <i class="fa-solid fa-check text-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 peer-checked:text-gray-400 peer-checked:line-through">${item}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-5 shadow-soft h-[300px] flex flex-col">
                    <h3 class="font-bold text-muji-text mb-2 border-l-4 border-cat-orange pl-3">éš¨æ‰‹ç­†è¨˜</h3>
                    <div class="text-xs text-gray-400 mb-2">è¼¸å…¥ç¶²å€æœƒè‡ªå‹•è½‰æ›æˆæŒ‰éˆ•</div>
                    <textarea id="memo-area" class="flex-1 w-full bg-muji-bg rounded-xl p-3 text-sm leading-relaxed outline-none resize-none border border-transparent focus:border-cat-orange" placeholder="åœ¨é€™è£¡è¨˜ä¸‹æƒ³å»çš„åœ°æ–¹ã€ä»£è³¼æ¸…å–®...">${memoContent}</textarea>
                    
                    <div class="mt-3 flex justify-between items-center">
                         <div id="memo-links" class="flex gap-2 overflow-x-auto max-w-[200px]">
                            </div>
                         <button onclick="saveMemo()" class="bg-cat-orange text-white px-4 py-2 rounded-lg text-sm font-bold">å„²å­˜</button>
                    </div>
                </div>
            </div>`;
        }

        function toggleCheck(item) {
            checklistState[item] = !checklistState[item];
            localStorage.setItem('trip_checklist', JSON.stringify(checklistState));
            // Re-render handled by checkbox state, no need full reload
        }

        function saveMemo() {
            const val = document.getElementById('memo-area').value;
            localStorage.setItem('trip_memo', val);
            memoContent = val;
            
            // Extract links for preview (simple implementation)
            const matches = val.match(/(https?:\/\/[^\s]+)/g);
            const linkContainer = document.getElementById('memo-links');
            if(matches) {
                linkContainer.innerHTML = matches.map((url, i) => 
                    `<a href="${url}" target="_blank" class="bg-gray-100 text-cat-orange text-xs px-2 py-1 rounded whitespace-nowrap"><i class="fa-solid fa-link"></i> Link ${i+1}</a>`
                ).join('');
            } else {
                linkContainer.innerHTML = '';
            }
            alert('ç­†è¨˜å·²å„²å­˜ ğŸ±');
        }

        // --- 5. INFO MODULE ---
        function renderInfo(container) {
            container.innerHTML = `
            <div class="p-4 space-y-4">
                <div class="bg-blue-50 p-5 rounded-2xl shadow-sm border border-blue-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-cloud-sun"></i></div>
                        <h3 class="font-bold text-blue-900">å¤©æ°£é å ±</h3>
                    </div>
                    <a href="https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=230000" target="_blank" class="block bg-white text-center py-2 rounded-lg text-blue-600 font-bold text-sm shadow-sm">
                        æŸ¥çœ‹åå¤å±‹ (æ—¥æœ¬æ°£è±¡å»³)
                    </a>
                </div>

                <div class="bg-red-50 p-5 rounded-2xl shadow-sm border border-red-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-phone"></i></div>
                        <h3 class="font-bold text-red-900">ç·Šæ€¥è¯çµ¡</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-2 rounded-lg text-center">
                            <div class="text-xs text-gray-500">è­¦å¯Ÿå±€</div>
                            <div class="text-lg font-black text-red-600 font-mono">110</div>
                        </div>
                        <div class="bg-white p-2 rounded-lg text-center">
                            <div class="text-xs text-gray-500">æ•‘è­·è»Š</div>
                            <div class="text-lg font-black text-red-600 font-mono">119</div>
                        </div>
                    </div>
                     <div class="mt-3 bg-white p-3 rounded-lg text-xs text-gray-600">
                        <strong>å°åŒ—é§å¤§é˜ªç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™•ï¼š</strong><br>
                        090-8794-4568 (ç·Šæ€¥è¯çµ¡é›»è©±)
                    </div>
                </div>

                 <div class="bg-white p-5 rounded-2xl shadow-soft">
                    <h3 class="font-bold text-muji-text mb-3"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-2"></i>æ³¨æ„äº‹é …</h3>
                    <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                        <li>æ—¥æœ¬é›»å£“ç‚º 100Vï¼Œå°ç£é›»å™¨å¤§å¤šé€šç”¨ï¼Œç„¡éœ€è½‰æ¥é ­ï¼ˆé›™æ‰è…³ï¼‰ã€‚</li>
                        <li>è‡ªé§•è«‹å‹™å¿…éµå®ˆã€Œè¡Œäººå„ªå…ˆã€èˆ‡ã€Œå³é§•å·¦è¡Œã€ã€‚</li>
                        <li>å…¥å¢ƒç¦æ­¢æ”œå¸¶è‚‰é¡è£½å“ï¼ˆå«æ³¡éºµè£¡çš„è‚‰å¡Šï¼‰ã€‚</li>
                    </ul>
                </div>
            </div>`;
        }

        // --- Start App ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
