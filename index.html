<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>貓的旅路 | 名古屋之旅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#fdfbf7', // 米白
                        'muji-text': '#4a4a4a', // 深灰
                        'cat-orange': '#e67e22', // 深橘
                        'cat-light': '#fce8d6', // 淺橘
                        'muji-gray': '#9ca3af'
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 隱藏 Scrollbar 但保持捲動 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 底部導航列選中效果 */
        .nav-item.active {
            color: #e67e22;
        }
        .nav-item.active i {
            transform: translateY(-2px);
        }

        /* 行程卡片選中樣式 */
        .plan-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .plan-card.active {
            border-color: #e67e22;
            background-color: #fffaf5;
            box-shadow: 0 4px 6px -1px rgba(230, 126, 34, 0.2);
        }
        /* 貓掌指示器 */
        .cat-paw {
            display: none;
            position: absolute;
            top: -10px;
            right: -5px;
            font-size: 1.5rem;
            color: #e67e22;
            transform: rotate(20deg);
            z-index: 10;
            background: #fdfbf7;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
        }
        .plan-card.active .cat-paw {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* 時間軸左側橘色線條 */
        .timeline-dot {
            transition: background-color 0.3s;
        }
        .plan-card.active ~ .timeline-dot, 
        .plan-card.active + .timeline-container .timeline-dot { 
            /* JS控制較穩，此處僅為輔助 */
        }

        @keyframes popIn {
            0% { transform: scale(0) rotate(0deg); }
            100% { transform: scale(1) rotate(20deg); }
        }

        /* 輸入框樣式 */
        input, textarea, select {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.5rem;
            outline: none;
        }
        input:focus, textarea:focus {
            border-color: #e67e22;
            ring: 2px solid #fce8d6;
        }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-20 shrink-0">
        <h1 class="text-xl font-bold text-cat-orange tracking-widest flex items-center gap-2">
            <i class="fa-solid fa-cat"></i> 貓的旅路
        </h1>
        <div class="text-xs text-muji-gray font-medium">Nagoya 2026</div>
    </header>

    <main id="main-container" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
        
        <section id="view-plan" class="view-section space-y-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-cat-orange">
                <h3 class="font-bold text-lg mb-2 text-stone-700">航班資訊</h3>
                <div class="flex justify-between items-center text-sm mb-2">
                    <div class="text-center">
                        <div class="font-bold text-2xl text-cat-orange">TPE</div>
                        <div class="text-xs text-stone-500">台北</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <i class="fa-solid fa-plane text-stone-400"></i>
                        <span class="text-xs text-stone-400">CI 0154</span>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-2xl text-cat-orange">NGO</div>
                        <div class="text-xs text-stone-500">名古屋</div>
                    </div>
                </div>
                <div class="bg-stone-100 rounded-lg p-2 text-xs text-stone-600 flex justify-between">
                    <span><i class="fa-regular fa-calendar mr-1"></i>02/06 去程</span>
                    <span>07:35 - 11:05</span>
                </div>
                <div class="bg-stone-100 rounded-lg p-2 text-xs text-stone-600 flex justify-between mt-1">
                    <span><i class="fa-regular fa-calendar mr-1"></i>02/14 回程</span>
                    <span>09:50 - 12:15 (CI 0151)</span>
                </div>
            </div>

            <div class="flex gap-2 mb-4 sticky top-0 bg-muji-bg py-2 z-10">
                <button onclick="switchDay('d1')" id="btn-d1" class="day-btn flex-1 py-2 rounded-xl font-bold text-sm bg-cat-orange text-white shadow-md transition">Day 1 (2/06)</button>
                <button onclick="switchDay('d2')" id="btn-d2" class="day-btn flex-1 py-2 rounded-xl font-bold text-sm bg-white text-stone-500 shadow-sm border border-stone-100 transition">Day 2 (2/07)</button>
            </div>

            <div id="itinerary-list" class="space-y-4 relative pl-4 border-l-2 border-stone-200 ml-2">
                </div>
        </section>

        <section id="view-guide" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold text-stone-800 border-b-4 border-cat-light inline-block pb-1">深度導覽</h2>
            
            <article class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="h-40 bg-gray-300 relative">
                     <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Nagoya_Station_Rotary_2017.jpg/640px-Nagoya_Station_Rotary_2017.jpg" class="w-full h-full object-cover" alt="名古屋">
                    <div class="absolute bottom-0 left-0 bg-black/50 text-white text-xs px-2 py-1">JR Gate Tower</div>
                </div>
                <div class="p-5">
                    <h3 class="font-bold text-lg text-cat-orange mb-2">名古屋的核心：JR Gate Tower</h3>
                    <p class="text-sm text-stone-600 leading-relaxed text-justify">
                        這裡不僅是購物中心，更是名古屋現代化的象徵。除了 Bic Camera 可以大採購電器外，Gate Tower 的高樓層餐廳擁有絕佳視野。
                        <br><br>
                        <strong>冷知識：</strong> 名古屋車站是金氏世界紀錄認證「世界最高的車站大樓」，其雙塔結構經常出現在動漫場景中。
                    </p>
                </div>
            </article>

            <article class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="h-40 bg-gray-300 relative">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Suzuka_Circuit_Ferris_Wheel_2011.jpg/640px-Suzuka_Circuit_Ferris_Wheel_2011.jpg" class="w-full h-full object-cover" alt="鈴鹿賽道">
                     <div class="absolute bottom-0 left-0 bg-black/50 text-white text-xs px-2 py-1">鈴鹿賽車樂園</div>
                </div>
                <div class="p-5">
                    <h3 class="font-bold text-lg text-cat-orange mb-2">速度的聖地：鈴鹿賽道</h3>
                    <p class="text-sm text-stone-600 leading-relaxed text-justify">
                        F1 日本大獎賽的舉辦地，是世界上少數的「8字形」立體交叉賽道。樂園內的設施多數可以由小朋友親自駕駛，強調「挑戰與達成」的教育意義。
                        <br><br>
                        <strong>必看重點：</strong> 即使不看賽車，樂園內的摩天輪也能眺望伊勢灣的絕美景色。
                    </p>
                </div>
            </article>
        </section>

        <section id="view-wallet" class="view-section hidden space-y-4">
            <div class="bg-stone-800 text-white p-4 rounded-2xl shadow-lg">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs text-stone-400">匯率 (JPY -> TWD)</label>
                    <input type="number" id="exchange-rate" value="0.22" class="w-16 bg-stone-700 text-right text-sm border-none rounded p-1" onchange="saveRate()">
                </div>
                <div class="relative">
                    <input type="text" id="calc-input" placeholder="輸入算式 (例: 500+200*3)" class="w-full bg-transparent text-3xl font-mono text-right border-none p-0 focus:ring-0 text-white placeholder-stone-600">
                    <div id="calc-result-twd" class="text-right text-cat-orange font-bold text-sm h-5">NT$ 0</div>
                </div>
                <div class="mt-3 grid grid-cols-4 gap-2">
                    <button onclick="addToCalc('+')" class="bg-stone-700 p-2 rounded hover:bg-stone-600">+</button>
                    <button onclick="addToCalc('-')" class="bg-stone-700 p-2 rounded hover:bg-stone-600">-</button>
                    <button onclick="addToCalc('*')" class="bg-stone-700 p-2 rounded hover:bg-stone-600">×</button>
                    <button onclick="calculate()" class="bg-cat-orange p-2 rounded font-bold shadow-lg shadow-orange-900/50">=</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h3 class="font-bold text-stone-700 mb-3"><i class="fa-solid fa-pen-to-square mr-2"></i>快速記帳</h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="expense-item" placeholder="品項 (如: 拉麵)" class="flex-1">
                    <input type="number" id="expense-price" placeholder="日幣" class="w-24">
                </div>
                <div class="flex justify-between items-center mt-2">
                    <label class="flex items-center gap-2 text-stone-500 text-sm cursor-pointer bg-stone-100 px-3 py-2 rounded-lg">
                        <i class="fa-solid fa-camera"></i> 拍照/上傳
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="previewImage(this)">
                    </label>
                    <button onclick="addExpense()" class="bg-cat-orange text-white px-6 py-2 rounded-lg font-bold shadow-md">儲存</button>
                </div>
                <div id="photo-preview-container" class="mt-2 hidden">
                    <span class="text-xs text-stone-400">預覽：</span>
                    <img id="photo-preview" class="h-16 rounded-lg object-cover border border-stone-200">
                </div>
            </div>

            <div id="expense-list" class="space-y-3 pb-10">
                </div>
            
            <div class="text-right">
                <button onclick="clearExpenses()" class="text-xs text-red-400 underline p-2">清空所有記帳</button>
            </div>
        </section>

        <section id="view-lists" class="view-section hidden space-y-6">
            
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-lg text-stone-800 mb-3 flex items-center">
                    <i class="fa-solid fa-clipboard-check text-cat-orange mr-2"></i>行前準備
                </h3>
                <div id="checklist-container" class="space-y-2">
                    </div>
                <div class="flex gap-2 mt-3">
                    <input type="text" id="new-check-item" placeholder="新增待辦..." class="flex-1 text-sm">
                    <button onclick="addCheckItem()" class="bg-stone-200 px-3 rounded-lg text-stone-600"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-lg text-stone-800 mb-3 flex items-center">
                    <i class="fa-solid fa-note-sticky text-cat-orange mr-2"></i>備忘錄 (自動轉連結)
                </h3>
                <textarea id="memo-input" rows="3" class="w-full mb-2 text-sm" placeholder="輸入文字或網址..."></textarea>
                <button onclick="addMemo()" class="w-full bg-cat-orange text-white py-2 rounded-lg font-bold text-sm mb-4">新增筆記</button>
                <div id="memo-list" class="space-y-2">
                    </div>
            </div>
        </section>

        <section id="view-info" class="view-section hidden space-y-4">
            <h2 class="text-2xl font-bold text-stone-800 border-b-4 border-cat-light inline-block pb-1">實用資訊</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-2xl text-center shadow-sm block">
                    <i class="fa-solid fa-cloud-sun text-3xl text-blue-400 mb-2"></i>
                    <div class="font-bold text-stone-700">日本氣象廳</div>
                </a>
                <a href="https://www.google.com/maps/search/hospital" target="_blank" class="bg-red-50 p-4 rounded-2xl text-center shadow-sm block">
                    <i class="fa-solid fa-truck-medical text-3xl text-red-400 mb-2"></i>
                    <div class="font-bold text-stone-700">鄰近醫院</div>
                </a>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-stone-800 mb-2">緊急聯絡</h3>
                <ul class="space-y-2 text-sm text-stone-600">
                    <li class="flex justify-between border-b pb-1"><span>警察局</span> <span class="font-mono font-bold text-red-500">110</span></li>
                    <li class="flex justify-between border-b pb-1"><span>火警/救護車</span> <span class="font-mono font-bold text-red-500">119</span></li>
                    <li class="flex justify-between"><span>旅外國人急難救助</span> <span class="font-mono font-bold">0800-085-095</span></li>
                </ul>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-yellow-400">
                <h3 class="font-bold text-stone-800 mb-2">⚠️ 注意事項</h3>
                <ul class="list-disc pl-5 text-sm text-stone-600 space-y-1">
                    <li>日本電壓 100V，插座為雙平腳（與台灣同）。</li>
                    <li>行走靠左，手扶梯規定不一（名古屋通常站左邊）。</li>
                    <li>室內吸菸請至指定吸菸室。</li>
                    <li>請勿邊走邊吃（觀光區除外）。</li>
                </ul>
            </div>
        </section>

    </main>

    <nav class="bg-white/95 backdrop-blur shadow-[0_-2px_10px_rgba(0,0,0,0.05)] h-20 flex justify-around items-center shrink-0 pb-4 z-30">
        <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center p-2 w-16 text-stone-400 transition">
            <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
            <span class="text-[10px] font-bold">行程</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center p-2 w-16 text-stone-400 transition">
            <i class="fa-solid fa-book-open text-xl mb-1"></i>
            <span class="text-[10px] font-bold">導覽</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center p-2 w-16 text-stone-400 transition">
            <i class="fa-solid fa-wallet text-xl mb-1"></i>
            <span class="text-[10px] font-bold">記帳</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center p-2 w-16 text-stone-400 transition">
            <i class="fa-solid fa-list-check text-xl mb-1"></i>
            <span class="text-[10px] font-bold">清單</span>
        </button>
        <button onclick="switchTab('info')" class="nav-item flex flex-col items-center p-2 w-16 text-stone-400 transition">
            <i class="fa-solid fa-circle-info text-xl mb-1"></i>
            <span class="text-[10px] font-bold">資訊</span>
        </button>
    </nav>

    <script>
        // --- DATA & STATE ---
        const itineraryData = {
            d1: [
                { time: "03:30", title: "機場接送", desc: "家裡 -> 桃園機場", icon: "fa-car", highlight: true },
                { time: "07:35", title: "起飛 CI 0154", desc: "TPE -> NGO", icon: "fa-plane-departure" },
                { time: "11:05", title: "抵達名古屋", desc: "中部國際機場", icon: "fa-plane-arrival" },
                { time: "12:00", title: "租車取車", desc: "Centrair, 1-chōme−1 1 第一", address: "〒479-0881 Aichi, Tokoname, Centrair, 1-chōme−1 1 第一, 日本", icon: "fa-key" },
                { time: "13:30", title: "JR Gate Tower", desc: "中餐 & Bic Camera", address: "1-1-4 Meieki, Nakamura-ku, Nagoya-shi, Aichi 450-6001", icon: "fa-utensils" },
                { time: "16:00", title: "前往飯店", desc: "鈴鹿賽車樂園酒店", address: "7992 Inoucho, Suzuka, Mie 510-0201日本", icon: "fa-hotel", highlight: true }
            ],
            d2: [
                { time: "09:00", title: "鈴鹿賽車樂園", desc: "玩到 17:00", address: "7992 Inoucho, Suzuka, Mie 510-0201日本", icon: "fa-flag-checkered", highlight: true },
                { time: "17:30", title: "晚餐 / 移動", desc: "返回名古屋市區", icon: "fa-car-side" },
                { time: "19:00", title: "入住 Airbnb", desc: "名古屋市緑區鳴海町", address: "愛知縣名古屋市緑區鳴海町字作町26號", icon: "fa-house-user" }
            ]
        };

        const defaultChecklist = [
            { id: 1, text: "護照", checked: false },
            { id: 2, text: "網卡 /漫遊開通", checked: false },
            { id: 3, text: "日幣現金", checked: false },
            { id: 4, text: "駕照日文譯本", checked: false },
            { id: 5, text: "行動電源", checked: false }
        ];

        let currentDay = 'd1';
        let selectedItineraryId = null;

        // --- INIT ---
        window.onload = function() {
            renderItinerary('d1');
            loadExpenses();
            loadChecklist();
            loadMemos();
            loadRate();
        };

        // --- NAVIGATION ---
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Show target
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find button calling this (simplified approach)
            const btns = document.querySelectorAll('.nav-item');
            const map = { 'plan': 0, 'guide': 1, 'wallet': 2, 'lists': 3, 'info': 4 };
            btns[map[tabId]].classList.add('active');

            // Scroll top
            document.getElementById('main-container').scrollTop = 0;
        }

        // --- PLAN LOGIC ---
        function switchDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('bg-cat-orange', 'text-white', 'shadow-md');
                btn.classList.add('bg-white', 'text-stone-500');
            });
            const activeBtn = document.getElementById('btn-' + day);
            activeBtn.classList.remove('bg-white', 'text-stone-500');
            activeBtn.classList.add('bg-cat-orange', 'text-white', 'shadow-md');
            
            renderItinerary(day);
        }

        function renderItinerary(day) {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            
            const items = itineraryData[day];
            items.forEach((item, index) => {
                const id = `item-${day}-${index}`;
                const isSelected = selectedItineraryId === id;
                const highlightClass = item.highlight ? 'text-cat-orange' : 'text-stone-400';
                
                let addressBtn = '';
                if(item.address) {
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`;
                    addressBtn = `<a href="${mapUrl}" target="_blank" class="mt-2 inline-block bg-white border border-stone-200 text-stone-600 text-xs px-3 py-1 rounded-full shadow-sm hover:bg-stone-50">
                        <i class="fa-solid fa-map-location-dot text-cat-orange mr-1"></i>導航
                    </a>`;
                }

                const html = `
                <div class="relative pb-6 timeline-container" onclick="toggleSelect('${id}')">
                    <div class="absolute -left-[23px] top-4 w-4 h-4 rounded-full bg-stone-200 border-2 border-white timeline-dot ${isSelected ? 'bg-cat-orange ring-2 ring-orange-200' : ''}" id="dot-${id}"></div>
                    
                    <div id="${id}" class="plan-card bg-white p-4 rounded-2xl shadow-sm relative ml-2 ${isSelected ? 'active' : ''}">
                        <div class="cat-paw"><i class="fa-solid fa-paw"></i></div>
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold font-mono text-xl ${highlightClass}">${item.time}</span>
                            <i class="fa-solid ${item.icon} text-stone-300"></i>
                        </div>
                        <h4 class="font-bold text-lg text-stone-700 leading-tight">${item.title}</h4>
                        <p class="text-sm text-stone-500 mt-1">${item.desc}</p>
                        ${addressBtn}
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        function toggleSelect(id) {
            // UI Update
            // Remove previous active
            document.querySelectorAll('.plan-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.timeline-dot').forEach(el => {
                el.classList.remove('bg-cat-orange', 'ring-2', 'ring-orange-200');
                el.classList.add('bg-stone-200');
            });

            if (selectedItineraryId === id) {
                // Deselect
                selectedItineraryId = null;
            } else {
                // Select new
                selectedItineraryId = id;
                const card = document.getElementById(id);
                const dot = document.getElementById('dot-' + id);
                if(card && dot) {
                    card.classList.add('active');
                    dot.classList.remove('bg-stone-200');
                    dot.classList.add('bg-cat-orange', 'ring-2', 'ring-orange-200');
                }
            }
        }

        // --- WALLET LOGIC ---
        function saveRate() {
            const rate = document.getElementById('exchange-rate').value;
            localStorage.setItem('travelApp_rate', rate);
            calculate();
        }
        function loadRate() {
            const rate = localStorage.getItem('travelApp_rate');
            if(rate) document.getElementById('exchange-rate').value = rate;
        }
        function addToCalc(val) {
            document.getElementById('calc-input').value += val;
        }
        function calculate() {
            const input = document.getElementById('calc-input');
            const resultDisplay = document.getElementById('calc-result-twd');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.22;
            
            try {
                // Simple sanitize
                const expression = input.value.replace(/[^0-9+\-*/.]/g, '');
                if (!expression) return;
                
                const jpy = eval(expression); // Client side calculator, low risk here
                input.value = jpy; // Update input with sum
                
                const twd = Math.round(jpy * rate);
                resultDisplay.innerText = `NT$ ${twd.toLocaleString()}`;
            } catch (e) {
                resultDisplay.innerText = "Error";
            }
        }

        let expenses = [];
        let tempPhoto = null;

        function previewImage(input) {
            if (input.files && input.files[0]) {
                // Compress Image
                const file = input.files[0];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Resize logic
                        const MAX_WIDTH = 400;
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        tempPhoto = canvas.toDataURL('image/jpeg', 0.6); // Compress Quality
                        
                        // Show UI
                        const preview = document.getElementById('photo-preview');
                        preview.src = tempPhoto;
                        document.getElementById('photo-preview-container').classList.remove('hidden');
                    }
                }
            }
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value;
            const price = parseFloat(document.getElementById('expense-price').value);
            
            if (!item || isNaN(price)) {
                alert("請輸入品項與金額");
                return;
            }

            const newExp = {
                id: Date.now(),
                item,
                price,
                photo: tempPhoto,
                date: new Date().toLocaleDateString()
            };

            expenses.unshift(newExp);
            localStorage.setItem('travelApp_expenses', JSON.stringify(expenses));
            
            // Reset UI
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-price').value = '';
            document.getElementById('photo-preview-container').classList.add('hidden');
            tempPhoto = null;
            
            loadExpenses();
        }

        function loadExpenses() {
            const stored = localStorage.getItem('travelApp_expenses');
            if (stored) expenses = JSON.parse(stored);
            
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.22;

            expenses.forEach(ex => {
                const twd = Math.round(ex.price * rate);
                const photoHtml = ex.photo ? `<img src="${ex.photo}" class="w-12 h-12 rounded bg-stone-200 object-cover ml-2">` : '';
                
                const html = `
                <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center">
                    <div class="flex items-center">
                        <div>
                            <div class="font-bold text-stone-700">${ex.item}</div>
                            <div class="text-xs text-stone-400">${ex.date}</div>
                        </div>
                        ${photoHtml}
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-cat-orange">¥${ex.price.toLocaleString()}</div>
                        <div class="text-xs text-stone-400">≈ NT$${twd.toLocaleString()}</div>
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }
        
        function clearExpenses() {
            if(confirm("確定刪除所有記帳紀錄？")) {
                localStorage.removeItem('travelApp_expenses');
                expenses = [];
                loadExpenses();
            }
        }

        // --- LISTS LOGIC ---
        function loadChecklist() {
            let data = JSON.parse(localStorage.getItem('travelApp_checklist'));
            if (!data) {
                data = defaultChecklist;
                localStorage.setItem('travelApp_checklist', JSON.stringify(data));
            }
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            
            data.forEach((item, index) => {
                const html = `
                <div class="flex items-center gap-3 p-2 bg-stone-50 rounded-lg">
                    <div onclick="toggleCheck(${index})" class="w-6 h-6 rounded border-2 ${item.checked ? 'bg-cat-orange border-cat-orange text-white' : 'border-stone-300 bg-white'} flex items-center justify-center cursor-pointer transition">
                        ${item.checked ? '<i class="fa-solid fa-check text-xs"></i>' : ''}
                    </div>
                    <span class="${item.checked ? 'line-through text-stone-400' : 'text-stone-700'}">${item.text}</span>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function toggleCheck(index) {
            let data = JSON.parse(localStorage.getItem('travelApp_checklist'));
            data[index].checked = !data[index].checked;
            localStorage.setItem('travelApp_checklist', JSON.stringify(data));
            loadChecklist();
        }

        function addCheckItem() {
            const input = document.getElementById('new-check-item');
            if(!input.value) return;
            let data = JSON.parse(localStorage.getItem('travelApp_checklist')) || [];
            data.push({ id: Date.now(), text: input.value, checked: false });
            localStorage.setItem('travelApp_checklist', JSON.stringify(data));
            input.value = '';
            loadChecklist();
        }

        // Memo Logic
        function addMemo() {
            const input = document.getElementById('memo-input');
            const text = input.value;
            if(!text) return;
            
            let memos = JSON.parse(localStorage.getItem('travelApp_memos')) || [];
            memos.unshift({ text, date: new Date().toLocaleString() });
            localStorage.setItem('travelApp_memos', JSON.stringify(memos));
            
            input.value = '';
            loadMemos();
        }

        function loadMemos() {
            const memos = JSON.parse(localStorage.getItem('travelApp_memos')) || [];
            const container = document.getElementById('memo-list');
            container.innerHTML = '';

            const urlRegex = /(https?:\/\/[^\s]+)/g;

            memos.forEach(m => {
                // Auto convert links
                let formattedText = m.text.replace(urlRegex, (url) => {
                    return `<a href="${url}" target="_blank" class="text-cat-orange underline"><i class="fa-solid fa-link mr-1"></i>連結</a>`;
                });

                const html = `
                <div class="bg-stone-50 p-3 rounded-lg border border-stone-100">
                    <p class="text-sm text-stone-700 whitespace-pre-wrap mb-1">${formattedText}</p>
                    <div class="text-[10px] text-stone-400 text-right">${m.date}</div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

    </script>
</body>
</html>
