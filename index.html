<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹æ»‘é›ªä¹‹æ—… ğŸ±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#fdfbf7',     /* æº«æš–ç±³ç™½ */
                        'muji-text': '#44403c',   /* æ·±å’– */
                        'cat-orange': '#ea580c',  /* æ·±æ©˜ (è²“ç´‹) */
                        'cat-light': '#fff7ed',   /* æ·ºæ©˜èƒŒæ™¯ */
                        'card-white': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 15px rgba(0, 0, 0, 0.05)',
                        'floating': '0 10px 25px rgba(234, 88, 12, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            color: #44403c;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* è¡Œç¨‹å¡ç‰‡äº’å‹•ç‰¹æ•ˆ */
        .trip-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .trip-card.active {
            border-color: #ea580c;
            background-color: #fff7ed;
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.1);
        }
        
        /* è²“æŒå°ç« å‹•ç•« */
        .paw-stamp {
            position: absolute;
            bottom: -10px;
            right: -10px;
            font-size: 4rem;
            color: #ea580c;
            opacity: 0;
            transform: scale(0.5) rotate(-20deg);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            z-index: 0;
        }
        .trip-card.active .paw-stamp {
            opacity: 0.1;
            transform: scale(1) rotate(0deg);
            bottom: -5px;
            right: -5px;
        }

        /* æ™‚é–“è»¸æ©˜è‰²é»é» */
        .timeline-dot {
            transition: background-color 0.3s, transform 0.3s;
        }
        .timeline-dot.active-dot {
            background-color: #ea580c !important;
            border-color: #fff;
            transform: scale(1.3);
            box-shadow: 0 0 0 3px #ffedd5;
        }

        /* å°è¦½é ï¼šæ‘ºç–Šå‹•ç•« */
        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .guide-content.open {
            max-height: 6000px; /* è¶³å¤ å¤§çš„é«˜åº¦ */
            opacity: 1;
        }
        .guide-arrow {
            transition: transform 0.3s;
        }
        .guide-arrow.open {
            transform: rotate(180deg);
            background-color: #ea580c;
            color: white;
            border-color: #ea580c;
        }

        /* åœ–ç‰‡è¼ªæ’­å®¹å™¨ */
        .scroll-gallery {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 1rem;
            padding-bottom: 1rem;
        }
        .scroll-item {
            scroll-snap-align: center;
            flex: 0 0 90%;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #eee;
            position: relative;
        }
        .scroll-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .muji-input {
            width: 100%;
            background: #f5f5f4;
            border: none;
            border-radius: 12px;
            padding: 12px;
            outline: none;
            transition: ring 0.2s;
        }
        .muji-input:focus {
            box-shadow: 0 0 0 2px #ea580c;
        }
        
        /* è¤‡è£½æç¤º */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }
        .toast.show { opacity: 1; }
        
        /* å°è¦½æ¨™ç±¤ */
        .guide-tag {
            background: linear-gradient(120deg, #ea580c 0%, #fb923c 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .guide-highlight {
            background-color: #ffedd5;
            padding: 0 4px;
            border-radius: 2px;
            color: #c2410c;
            font-weight: bold;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-sm">

    <header class="bg-card-white shadow-sm px-5 py-4 z-20 flex justify-between items-center relative shrink-0">
        <div>
            <h1 class="text-lg font-black text-muji-text tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-person-skiing text-cat-orange"></i>
                åå¤å±‹æ»‘é›ªä¹‹æ—…
            </h1>
            <p class="text-[10px] text-gray-400 font-bold mt-1 tracking-widest uppercase">Nagoya & Nagano Trip</p>
        </div>
        <div class="w-9 h-9 bg-cat-light rounded-full flex items-center justify-center text-cat-orange shadow-sm border border-orange-100">
            <i class="fa-solid fa-cat text-base"></i>
        </div>
    </header>

    <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar pb-24 relative bg-muji-bg scroll-smooth">
        </main>

    <nav class="bg-card-white/95 backdrop-blur-md border-t border-gray-100 fixed bottom-0 w-full pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="router('plan')" class="nav-btn group flex flex-col items-center w-full" id="btn-plan">
                <div class="nav-icon text-lg mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-calendar-days"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">è¡Œç¨‹</span>
            </button>
            <button onclick="router('guide')" class="nav-btn group flex flex-col items-center w-full" id="btn-guide">
                <div class="nav-icon text-lg mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-book-open"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">å°è¦½</span>
            </button>
            <button onclick="router('wallet')" class="nav-btn group flex flex-col items-center w-full" id="btn-wallet">
                <div class="nav-icon text-lg mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-calculator"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">è¨˜å¸³</span>
            </button>
            <button onclick="router('lists')" class="nav-btn group flex flex-col items-center w-full" id="btn-lists">
                <div class="nav-icon text-lg mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-list-check"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">æ¸…å–®</span>
            </button>
            <button onclick="router('info')" class="nav-btn group flex flex-col items-center w-full" id="btn-info">
                <div class="nav-icon text-lg mb-1 text-gray-400 group-hover:text-cat-orange transition-colors"><i class="fa-solid fa-circle-info"></i></div>
                <span class="text-[10px] text-gray-500 font-bold">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <div id="img-modal" class="fixed inset-0 bg-black/95 hidden z-50 flex justify-center items-center p-2 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <img id="img-modal-src" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">
    </div>
    
    <div id="toast" class="toast">åœ°å€å·²è¤‡è£½</div>

    <script>
        // --- Data Configuration ---
        const tripData = {
            flights: [
                { type: 'å»ç¨‹', date: '02/06', code: 'CI 0154', route: 'TPE 07:35 â NGO 11:05' },
                { type: 'å›ç¨‹', date: '02/14', code: 'CI 0151', route: 'NGO 09:50 â TPE 12:15' }
            ],
            // Auto generate dates: 2026-02-06 is Friday
            days: [
                { key: 'd1', date: '2/06', week: 'Fri' },
                { key: 'd2', date: '2/07', week: 'Sat' },
                { key: 'd3', date: '2/08', week: 'Sun' },
                { key: 'd4', date: '2/09', week: 'Mon' },
                { key: 'd5', date: '2/10', week: 'Tue' },
                { key: 'd6', date: '2/11', week: 'Wed' },
                { key: 'd7', date: '2/12', week: 'Thu' },
                { key: 'd8', date: '2/13', week: 'Fri' },
                { key: 'd9', date: '2/14', week: 'Sat' }
            ],
            itinerary: {
                d1: [
                    { time: '03:00', title: 'æ©Ÿå ´æ¥é€', desc: 'å®¶è£¡ -> æ¡ƒåœ’æ©Ÿå ´', type: 'transport', highlight: true },
                    { time: '07:35', title: 'èµ·é£› CI 0154', desc: 'é£›å¾€åå¤å±‹', type: 'flight' },
                    { time: '11:05', title: 'æŠµé”åå¤å±‹', desc: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´', type: 'arrival' },
                    { time: '12:00', title: 'å–è»Š (AQ Relax)', desc: 'åœç•™ï¼š30åˆ†é˜\nã€’479-0881 Aichi, Tokoname', type: 'car', addr: 'ã€’479-0881 Aichi, Tokoname, Centrair, 1-chÅmeâˆ’1 1 ç¬¬ä¸€, æ—¥æœ¬' },
                    { time: '13:30', title: 'JR Gate Tower Mall', desc: 'åœç•™ï¼š3å°æ™‚\nåœè»Šï¼šã‚¿ãƒ¯ãƒ¼ã‚ºä¸€èˆ¬é§è»Šå ´ å—å£å…¥å£', type: 'shop', addr: '1 Chome-26-34 Meiekiminami, Nakamura Ward, Nagoya, Aichi 450-0003æ—¥æœ¬' },
                    { time: '18:00', title: 'ä½å®¿ï¼šéˆ´é¹¿è³½é“æ¨‚åœ’é…’åº—', desc: 'åŒ—æ£Ÿè³½è»Šæˆ¿ | å«æ—©æ™šé¤\nå«4å¼µæ¨‚åœ’è­·ç…§èˆ‡è³½é“è²´ä¼‘æ¯å®¤å·', type: 'hotel', addr: 'éˆ´é¹¿ã‚µãƒ¼ã‚­ãƒƒãƒˆé§è»Šå ´ M2, æ—¥æœ¬ã€’510-0201 Mie, Suzuka, Inoucho, 7992' },
                    { time: '19:30', title: 'æ™šé¤', desc: 'é£¯åº—è‡ªåŠ©æ™šé¤', type: 'food' }
                ],
                d2: [
                    { time: '07:00', title: 'æ—©é¤', desc: 'é£¯åº—è‡ªåŠ©æ—©é¤', type: 'food' },
                    { time: '09:30', title: 'éˆ´é¹¿è³½è»Šæ¨‚åœ’', desc: 'æ‹¿ä¸­æ–‡åœ°åœ–ï¼ŒæƒQRçœ‹è¨­æ–½æ’éšŠ', type: 'play', highlight: true },
                    { time: '13:10', title: 'è³½é“æŒ‘æˆ°è€…', desc: 'åœç•™ï¼š40åˆ†é˜\næ†‘ä¹˜è»Šå·x3 (Hotmail)', type: 'play', highlight: true },
                    { time: '14:30', title: 'åˆé¤ï¼šGRAN VIEW', desc: 'æ¨‚åœ’å…§é¤å»³ (ç©å®Œå†åƒ)', type: 'food' },
                    { time: '18:00', title: 'æ™šé¤ï¼šè¬ä¾†äº­æ‹‰éºµ', desc: 'åœç•™ï¼š1å°æ™‚\nåœè»Šå ´ï¼šBanraitei Parking Lot', type: 'food', addr: 'Banraitei Parking Lot, 2 Chome Shiomigaoka, Midori Ward, Nagoya, Aichi 458-0037æ—¥æœ¬' },
                    { time: '20:00', title: 'ä½å®¿ï¼šAirbnb', desc: 'æ„›çŸ¥ç¸£åå¤å±‹å¸‚ç·‘å€', type: 'hotel', addr: 'æ„›çŸ¥ç¸£åå¤å±‹å¸‚ç·‘å€é³´æµ·ç”ºå­—ä½œç”º26è™Ÿ' }
                ],
                d3: [
                    { time: '07:00', title: 'æ—©é¤ï¼šè¶…å•†å·¡ç¦®', desc: 'åœç•™30åˆ†é˜', type: 'food' },
                    { time: '', title: '7-11 åå¤å±‹æµ¦é‡Œ5ä¸ç›®', desc: 'ç¬¬ä¸€ç«™', type: 'shop', addr: 'åå¤å±‹å¸‚ç·‘åŒºæµ¦é‡Œ5-203' },
                    { time: '', title: '7-11 åå¤å±‹è—¥å¸«å±±', desc: 'ç¬¬äºŒç«™', type: 'shop', addr: 'åå¤å±‹å¸‚ç·‘åŒºé³´æµ·ç”ºå­—è–¬å¸«å±±179-1' },
                    { time: '', title: 'FamilyMart æ½®è¦‹ä¹‹ä¸˜', desc: 'ç¬¬ä¸‰ç«™', type: 'shop', addr: 'åå¤å±‹å¸‚ç·‘åŒºæ½®è¦‹ãŒä¸˜1-79' },
                    { time: '08:00', title: 'å‰åœåŠ›å…¬åœ’åŒ—å£åœè»Šå ´', desc: 'ç©åˆ° 13:00', type: 'car', addr: '1533-1 Ibaragabasama, Nagakute, Aichi 480-1342æ—¥æœ¬' },
                    { time: '16:00', title: 'æ™šé¤èˆ‡ä½å®¿ï¼šæ± ä¹‹å¹³é£¯åº—', desc: 'é•·é‡ç¸£', type: 'hotel', addr: '1596 Ashidahakkano, Tateshina, Kitasaku District, Nagano 391-0321æ—¥æœ¬' }
                ],
                d4: [
                    { time: '07:30', title: 'æ—©é¤', desc: 'æ± ä¹‹å¹³é£¯åº—', type: 'food' },
                    { time: '09:00', title: 'ç™½æ¨ºé«˜åŸåœ‹éš›æ»‘é›ªå ´', desc: 'å…¨æ—¥æ»‘é›ª', type: 'person-skiing', highlight: true, addr: '743 Ashidahakkano, Tateshina, Kitasaku District, Nagano 384-2309æ—¥æœ¬' },
                    { time: '17:00', title: 'æ± ä¹‹å¹³é£¯åº—', desc: 'æ™šé¤èˆ‡ä½å®¿', type: 'hotel', addr: '1596 Ashidahakkano, Tateshina, Kitasaku District, Nagano 391-0321æ—¥æœ¬' }
                ],
                d5: [
                    { time: '07:30', title: 'æ—©é¤', desc: 'æ± ä¹‹å¹³é£¯åº—', type: 'food' },
                    { time: '09:00', title: 'ç™½æ¨ºé«˜åŸåœ‹éš›æ»‘é›ªå ´', desc: 'å…¨æ—¥æ»‘é›ª', type: 'person-skiing', highlight: true, addr: '743 Ashidahakkano, Tateshina, Kitasaku District, Nagano 384-2309æ—¥æœ¬' },
                    { time: '17:00', title: 'æ± ä¹‹å¹³é£¯åº—', desc: 'æ™šé¤èˆ‡ä½å®¿', type: 'hotel', addr: '1596 Ashidahakkano, Tateshina, Kitasaku District, Nagano 391-0321æ—¥æœ¬' }
                ],
                d6: [
                    { time: '07:30', title: 'æ—©é¤', desc: 'æ± ä¹‹å¹³é£¯åº—', type: 'food' },
                    { time: '09:00', title: 'è»Šå±±é«˜åŸæ»‘é›ªå ´', desc: 'å…¨æ—¥æ»‘é›ª', type: 'person-skiing', highlight: true, addr: 'æ—¥æœ¬ã€’391-0301 Nagano, Chino, Kitayama, è»Šå±±3413' },
                    { time: '17:00', title: 'æ± ä¹‹å¹³é£¯åº—', desc: 'æ™šé¤èˆ‡ä½å®¿', type: 'hotel', addr: '1596 Ashidahakkano, Tateshina, Kitasaku District, Nagano 391-0321æ—¥æœ¬' }
                ],
                d7: [
                    { time: '07:30', title: 'æ—©é¤', desc: 'æ± ä¹‹å¹³é£¯åº—', type: 'food' },
                    { time: '09:00', title: 'è»Šå±±é«˜åŸæ»‘é›ªå ´', desc: 'åŠæ—¥æ»‘é›ª & ä¸­é¤', type: 'person-skiing', addr: 'æ—¥æœ¬ã€’391-0301 Nagano, Chino, Kitayama, è»Šå±±3413' },
                    { time: '17:00', title: 'æ™šé¤ï¼šçŸ¢å ´ä¸¼ / ç†±ç”°è“¬èŠè»’', desc: 'AEON MALL Nagoya Dome', type: 'food', addr: 'AEON MALL NAGOYA DOME MAE, 4 Chome-102-3 Yadaminami, Higashi Ward, Nagoya, Aichi 461-0048æ—¥æœ¬' },
                    { time: '20:00', title: 'ä½å®¿ï¼šAirbnb', desc: 'åå¤å±‹å¸‚å€', type: 'hotel', addr: '1-chÅme-43-6 Yutaka, Nagoya, Aichi 457-0863' }
                ],
                d8: [
                    { time: '08:00', title: 'æ—©é¤ï¼šå®¢ç¾å¤šå’–å•¡ å¿ æ¬¡åº—', desc: 'åå¤å±‹å¼æ—©é¤', type: 'food', addr: 'æ—¥æœ¬ã€’457-0843 Aichi, Nagoya, Minami Ward, Chuji, 2 Chomeâˆ’1âˆ’1' },
                    { time: '10:00', title: 'å¸¸æ»‘æ‹›è²¡è²“é€š', desc: 'å¸¸æ»‘å¸‚é™¶ç“·å™¨æœƒé¤¨åœè»Šå ´', type: 'play', addr: 'æ—¥æœ¬ã€’479-0836 Aichi, Tokoname, Sakaemachi, 3 Chomeâˆ’8' },
                    { time: '12:00', title: 'ä¸­é¤ï¼šä¸¸è‘‰é£Ÿå ‚', desc: 'å¿…é»ç‚¸å¤§è¦å®šé£Ÿ', type: 'food', addr: 'æ—¥æœ¬ã€’479-0882 Aichi, Tokoname, Rinkucho, 3 Chomeâˆ’9-5' },
                    { time: '14:00', title: 'AEON å¸¸æ»‘', desc: 'è³¼ç‰©', type: 'shop', addr: '2 Chome-20-3 Rinkucho, Tokoname, Aichi 479-0882æ—¥æœ¬' },
                    { time: '17:00', title: 'é‚„è»Š (AQ Relax)', desc: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´', type: 'car', addr: 'ã€’479-0881 Aichi, Tokoname, Centrair, 1-chÅmeâˆ’1 1 ç¬¬ä¸€, æ—¥æœ¬' },
                    { time: '18:00', title: 'è²·ä¼´æ‰‹ç¦® & æ™šé¤', desc: 'T1 3FéŠ˜å“é¤¨ / 4Fé¤å»³\nä¸–ç•Œçš„å±±å°‡ã€é°»é­šé£¯ã€çŸ¢å ´è±¬æ’', type: 'shop' },
                    { time: '20:00', title: 'ä½å®¿ï¼šä¸­éƒ¨åœ‹éš›æ©Ÿå ´é…’åº—', desc: 'T1 æ—', type: 'hotel', addr: 'æ„›çŸ¥ç¸£, Tokoname, Centrair 1-1, æ—¥æœ¬' }
                ],
                d9: [
                    { time: '09:50', title: 'èµ·é£›', desc: 'CI 0151', type: 'flight' },
                    { time: '12:15', title: 'æŠµé”å°ç£', desc: 'TPE', type: 'arrival' },
                    { time: '13:00', title: 'æ©Ÿå ´æ¥é€', desc: 'å›å®¶å›‰~', type: 'car', highlight: true }
                ]
            }
        };

        // --- State Management ---
        let currentDay = 'd1';
        let walletRate = parseFloat(localStorage.getItem('trip_rate')) || 0.22;
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
        let checklistState = JSON.parse(localStorage.getItem('trip_checklist')) || {};
        let memoContent = localStorage.getItem('trip_memo') || '';

        // --- Icons Mapping ---
        const icons = {
            transport: 'fa-car-side',
            flight: 'fa-plane-departure',
            arrival: 'fa-plane-arrival',
            car: 'fa-key',
            food: 'fa-utensils',
            hotel: 'fa-bed',
            play: 'fa-ticket',
            shop: 'fa-bag-shopping',
            'person-skiing': 'fa-person-skiing'
        };

        // --- Core Functions ---
        function init() {
            router('plan');
        }

        function router(page) {
            document.querySelectorAll('.nav-btn .nav-icon').forEach(el => el.classList.replace('text-cat-orange', 'text-gray-400'));
            const btn = document.getElementById('btn-' + page);
            if(btn) btn.querySelector('.nav-icon').classList.replace('text-gray-400', 'text-cat-orange');

            const content = document.getElementById('app-content');
            content.innerHTML = ''; 
            content.scrollTop = 0;

            switch(page) {
                case 'plan': renderPlan(content); break;
                case 'guide': renderGuide(content); break;
                case 'wallet': renderWallet(content); break;
                case 'lists': renderLists(content); break;
                case 'info': renderInfo(content); break;
            }
        }

        // --- 1. PLAN MODULE ---
        function renderPlan(container) {
            let flightHTML = `<div class="p-4 space-y-3">
                <div class="bg-white p-4 rounded-2xl shadow-soft">
                    <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Flight Info</h3>
                    ${tripData.flights.map(f => `
                        <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0">
                            <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">${f.type}</span>
                            <span class="text-sm font-bold text-muji-text">${f.code}</span>
                            <span class="text-xs text-gray-500">${f.route}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;

            let switcherHTML = `<div class="flex px-4 gap-2 mb-4 sticky top-0 z-10 py-2 bg-muji-bg/95 backdrop-blur overflow-x-auto no-scrollbar">`;
            tripData.days.forEach(d => {
                switcherHTML += `
                <button onclick="switchDay('${d.key}')" id="btn-${d.key}" class="min-w-[70px] flex-1 py-2 rounded-xl text-xs font-bold transition-all shadow-sm flex flex-col items-center border border-gray-100 ${currentDay === d.key ? 'bg-cat-orange text-white border-cat-orange' : 'bg-white text-gray-400'}">
                    <span>${d.date}</span>
                    <span class="text-[10px] opacity-80">${d.week}</span>
                </button>`;
            });
            switcherHTML += `</div>`;

            let timelineHTML = `<div id="timeline-list" class="px-4 pb-8 space-y-4">${renderDayItems(currentDay)}</div>`;

            container.innerHTML = flightHTML + switcherHTML + timelineHTML;
            checkSelection();
        }

        function switchDay(day) {
            currentDay = day;
            tripData.days.forEach(d => {
                const btn = document.getElementById(`btn-${d.key}`);
                if(btn) {
                    btn.className = `min-w-[70px] flex-1 py-2 rounded-xl text-xs font-bold transition-all shadow-sm flex flex-col items-center border border-gray-100 ${day === d.key ? 'bg-cat-orange text-white border-cat-orange' : 'bg-white text-gray-400'}`;
                }
            });
            document.getElementById('timeline-list').innerHTML = renderDayItems(day);
            checkSelection();
        }

        function renderDayItems(day) {
            return tripData.itinerary[day].map((item, index) => {
                const iconClass = icons[item.type] || 'fa-location-dot';
                const highlightClass = item.highlight ? 'text-cat-orange' : 'text-gray-400';
                const uniqueId = `${day}-${index}`;
                
                const mapBtn = item.addr ? 
                    `<div class="mt-3 flex gap-2">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.addr)}" target="_blank" class="flex-1 inline-flex justify-center items-center text-xs bg-gray-50 border border-gray-200 hover:bg-orange-50 hover:border-orange-200 text-gray-600 px-3 py-2 rounded-lg transition-colors shadow-sm" onclick="event.stopPropagation()">
                            <i class="fa-solid fa-map-location-dot mr-1.5 text-cat-orange"></i> å°èˆª
                        </a>
                        <button onclick="copyAddr('${item.addr}'); event.stopPropagation();" class="inline-flex justify-center items-center w-10 text-xs bg-gray-50 border border-gray-200 text-gray-500 rounded-lg active:bg-gray-200">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                    </div>` : '';

                return `
                <div class="flex gap-4 group" onclick="toggleSelection('${uniqueId}')">
                    <div class="flex flex-col items-center min-w-[3rem] pt-2">
                        <span class="text-xs font-bold font-mono text-gray-500 mb-1">${item.time || '--:--'}</span>
                        <div class="w-3.5 h-3.5 rounded-full bg-gray-200 border-2 border-white shadow-sm z-10 timeline-dot" id="dot-${uniqueId}"></div>
                        ${index !== tripData.itinerary[day].length - 1 ? '<div class="w-0.5 flex-1 bg-gray-200 my-1"></div>' : ''}
                    </div>
                    
                    <div class="flex-1 pb-4">
                        <div id="card-${uniqueId}" class="trip-card bg-white p-4 rounded-2xl shadow-soft relative">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-base text-muji-text ${item.highlight ? 'text-cat-orange' : ''}">${item.title}</h4>
                                    <p class="text-xs text-gray-500 mt-2 leading-relaxed whitespace-pre-line">${item.desc}</p>
                                </div>
                                <i class="fa-solid ${iconClass} ${highlightClass} opacity-20 text-2xl absolute top-3 right-3"></i>
                            </div>
                            ${mapBtn}
                            <i class="fa-solid fa-paw paw-stamp"></i>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleSelection(id) {
            document.querySelectorAll('.trip-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.timeline-dot').forEach(el => el.classList.remove('active-dot'));
            
            const card = document.getElementById(`card-${id}`);
            const dot = document.getElementById(`dot-${id}`);
            if(card) card.classList.add('active');
            if(dot) dot.classList.add('active-dot');
            
            localStorage.setItem('trip_current_selection', id);
        }

        function checkSelection() {
            const savedId = localStorage.getItem('trip_current_selection');
            // Only toggle if element exists (handling day switching)
            if(savedId && document.getElementById(`card-${savedId}`)) {
                toggleSelection(savedId);
            }
        }

        function copyAddr(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        // --- 2. GUIDE MODULE ---
        function renderGuide(container) {
            // Replaced blob with raw for images
            const parkingImages = [
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E3%82%BF%E3%83%AF%E3%83%BC%E3%82%BA%E4%B8%80%E8%88%AC%E9%A7%90%E8%BB%8A%E5%A0%B4-%E5%8D%97%E5%8F%A3%E5%85%A5%E5%8F%A3-1.png",
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E3%82%BF%E3%83%AF%E3%83%BC%E3%82%BA%E4%B8%80%E8%88%AC%E9%A7%90%E8%BB%8A%E5%A0%B4-%E5%8D%97%E5%8F%A3%E5%85%A5%E5%8F%A3-2.png",
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E3%82%BF%E3%83%AF%E3%83%BC%E3%82%BA%E4%B8%80%E8%88%AC%E9%A7%90%E8%BB%8A%E5%A0%B4-%E5%8D%97%E5%8F%A3%E5%85%A5%E5%8F%A3-3.png",
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E3%82%BF%E3%83%AF%E3%83%BC%E3%82%BA%E4%B8%80%E8%88%AC%E9%A7%90%E8%BB%8A%E5%A0%B4-%E5%8D%97%E5%8F%A3%E5%85%A5%E5%8F%A3-4.png"
            ];
            
            const suzukaImages = [
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E9%88%B4%E9%B9%BF%E8%B3%BD%E9%81%93%E6%A8%82%E5%9C%92%E9%85%92%E5%BA%97%E5%81%9C%E8%BB%8A%E5%A0%B4%E5%85%A5%E5%8F%A3-1.png",
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E9%88%B4%E9%B9%BF%E8%B3%BD%E9%81%93%E6%A8%82%E5%9C%92%E9%85%92%E5%BA%97%E5%81%9C%E8%BB%8A%E5%A0%B4%E5%85%A5%E5%8F%A3-2.png",
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E9%88%B4%E9%B9%BF%E8%B3%BD%E9%81%93%E6%A8%82%E5%9C%92%E9%85%92%E5%BA%97%E5%81%9C%E8%BB%8A%E5%A0%B4%E5%85%A5%E5%8F%A3-3.png"
            ];

            const ghibliParkingImg = "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E5%90%89%E5%8D%9C%E5%8A%9B%E5%8C%971%E5%81%9C%E8%BB%8A%E5%A0%B4%E5%85%A5%E5%8F%A3.png";
            
            const ghibliApmImages = [
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E5%90%89%E5%8D%9C%E5%8A%9B%E5%8C%971%E5%81%9C%E8%BB%8A%E5%A0%B4-APM%E8%B3%BC%E7%A5%A8%E8%99%95.jpg",
                "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E5%90%89%E5%8D%9C%E5%8A%9B%E5%8C%971%E5%81%9C%E8%BB%8A%E5%A0%B4-APM%E8%B3%BC%E7%A5%A8%E8%99%952.jpg"
            ];
            
            const ghibliStrategyImg = "https://raw.githubusercontent.com/LulumeQQ/NGO-202602/main/%E5%90%89%E5%8D%9C%E5%8A%9B%E6%94%BB%E7%95%A5.png";

            const loginUrl = "https://d-reserve.jp/auth/realms/M000000678/protocol/openid-connect/auth?response_type=code&client_id=directin-s4&redirect_uri=https%3A%2F%2Fd-reserve.jp%2Fguest-reserve-front%2Fsso%2Flogin?hotelCode%3D0000001590%26return_url%3Dhttps%253A%252F%252Fd-reserve.jp%252Fauth%252Frealms%252Fdirectin-s4%252Fcdp%252Fgroups%252FM000000678%252Fredirects%252Faccount%253Freferrer_uri%253Dhttps%25253A%25252F%25252Fd-reserve.jp%25252FGSEA001F01300%25252FGSEA001A01%25253FhotelCode%25253D0000001590%252526lang%25253Den&state=faadacc5-08c9-485f-972f-9681fbea58dd&login=true&ui_locales=en&scope=openid";

            const createGuideCard = (id, title, tag, contentHTML, coverImg) => `
                <div class="bg-white rounded-3xl overflow-hidden shadow-soft transition-all mb-6">
                    <div class="relative h-48 cursor-pointer group" onclick="toggleGuide('${id}')">
                        <img src="${coverImg}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent flex flex-col justify-end p-6">
                            <span class="guide-tag self-start">${tag}</span>
                            <div class="flex justify-between items-end">
                                <h2 class="text-2xl font-black text-white drop-shadow-md">${title}</h2>
                                <button class="bg-white/20 backdrop-blur-md text-white border border-white/50 rounded-full w-8 h-8 flex items-center justify-center guide-arrow" id="arrow-${id}">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="guide-${id}" class="guide-content bg-white">
                        <div class="p-6 border-t border-gray-100">
                            ${contentHTML}
                        </div>
                        <div class="text-center pb-4 pt-2 cursor-pointer text-gray-400 hover:text-cat-orange" onclick="toggleGuide('${id}')">
                            <span class="text-xs uppercase font-bold tracking-widest"><i class="fa-solid fa-chevron-up mr-1"></i>æ”¶åˆå…§å®¹</span>
                        </div>
                    </div>
                </div>
            `;

            const jrContent = `
                <div class="bg-gray-50 border border-gray-100 rounded-xl p-4 mb-6">
                     <h3 class="font-bold text-sm text-muji-text mb-3 flex items-center">
                        <i class="fa-solid fa-square-parking text-cat-orange mr-2"></i>åœè»Šå ´å…¥å£ (ä¸€èˆ¬/å—å£)
                    </h3>
                    <div class="scroll-gallery no-scrollbar">
                        ${parkingImages.map((img, i) => `
                            <div class="scroll-item shadow-sm h-40">
                                <img src="${img}" class="w-full h-full object-cover" onclick="showFullImage('${img}')">
                                <div class="scroll-indicator">${i+1}/4</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center text-[10px] text-gray-400 mt-2"><i class="fa-solid fa-left-right mr-1"></i>å·¦å³æ»‘å‹•æŸ¥çœ‹ç¤ºæ„åœ–</div>
                </div>
                <div class="space-y-6">
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm leading-relaxed">
                        <p class="font-bold text-cat-orange mb-1">ã‚¿ãƒ¯ãƒ¼ã‚ºä¸€èˆ¬é§è»Šå ´ å—å£å…¥å£</p>
                        <p class="text-gray-600 mb-2 text-xs">å»ºè­°ç›´æ¥åœ¨å°èˆªè¼¸å…¥ä¸‹æ–¹é›»è©±ï¼Œé€™æ˜¯æœ€ä¿éšªçš„æ–¹å¼ã€‚</p>
                        <a href="tel:0525867811" class="flex items-center justify-center bg-white border border-orange-200 text-cat-orange font-mono font-bold py-2 rounded-lg shadow-sm active:scale-95 transition-transform">
                            <i class="fa-solid fa-phone mr-2"></i> 052-586-7811
                        </a>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-muji-text mb-3 flex items-center"><i class="fa-solid fa-camera text-cat-orange mr-2"></i>Bic Camera æ”»ç•¥</h3>
                        <p class="text-xs text-gray-500 mb-3 ml-6">ä½æ–¼ JR Gate Tower 9F/10F</p>
                        <div class="bg-white border border-gray-100 p-4 rounded-xl text-sm shadow-sm">
                            <p class="font-bold text-gray-700 mb-3 border-b pb-2">ğŸ…¿ï¸ åœè»ŠæŠ˜æŠµ</p>
                            <ul class="space-y-3 text-gray-600 text-xs">
                                <li class="flex justify-between"><span>æ»¿ <span class="font-mono text-base">5,000</span></span> <span class="bg-gray-100 px-2 py-1 rounded font-bold">æŠ˜ 1 hr</span></li>
                                <li class="flex justify-between"><span>æ»¿ <span class="font-mono text-base">20,000</span></span> <span class="bg-gray-100 px-2 py-1 rounded font-bold">æŠ˜ 2 hr</span></li>
                                <li class="flex justify-between"><span>æ»¿ <span class="font-mono text-base">50,000</span></span> <span class="bg-gray-100 px-2 py-1 rounded font-bold">æŠ˜ 3 hr</span></li>
                            </ul>
                            <div class="mt-3 flex items-start gap-2 text-xs text-red-500 bg-red-50 p-2 rounded">
                                <i class="fa-solid fa-circle-exclamation mt-0.5"></i>
                                <span>çµå¸³æ™‚å‹™å¿…å‡ºç¤ºåœè»Šåˆ¸ã€‚</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const suzukaContent = `
                <div class="bg-gray-50 border border-gray-100 rounded-xl p-4 mb-6">
                     <h3 class="font-bold text-sm text-muji-text mb-3 flex items-center">
                        <i class="fa-solid fa-square-parking text-cat-orange mr-2"></i>ä½å®¿è€…å°ˆç”¨åœè»Šå ´
                    </h3>
                    <div class="scroll-gallery no-scrollbar">
                        ${suzukaImages.map((img, i) => `
                            <div class="scroll-item shadow-sm h-40">
                                <img src="${img}" class="w-full h-full object-cover" onclick="showFullImage('${img}')">
                                <div class="scroll-indicator">${i+1}/3</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="space-y-4">
                     <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm leading-relaxed">
                        <p class="font-bold text-cat-orange mb-2"><i class="fa-solid fa-bell mr-1"></i>Check-in é ˆçŸ¥</p>
                        <p class="text-gray-700 mb-2">æ«ƒå°ä½æ–¼<span class="font-bold">ã€Œä¸»æ£Ÿã€</span>ã€‚</p>
                        <p class="text-gray-600 text-xs">ç„¡è«–ä½å“ªä¸€æ£Ÿï¼Œè«‹å…ˆè‡³ä¸»æ£Ÿè¾¦ç†å…¥ä½ï¼Œå·¥ä½œäººå“¡æœƒæŒ‡å¼•æœ€è¿‘åœè»Šå ´ã€‚</p>
                    </div>
                    <a href="${loginUrl}" target="_blank" class="block w-full bg-muji-text text-white text-center font-bold py-3 rounded-xl shadow-lg hover:bg-black transition-colors active:scale-95">
                        <i class="fa-solid fa-right-to-bracket mr-2"></i>é£¯åº—ç™»å…¥ (Check-in)
                    </a>
                </div>
            `;

            const ghibliContent = `
                <div class="mb-8">
                     <h3 class="font-bold text-lg text-muji-text mb-3 border-l-4 border-cat-orange pl-3">1. åŒ—å£åœè»Šå ´ & APM</h3>
                     <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="scroll-item h-28 w-full"><img src="${ghibliParkingImg}" class="w-full h-full object-cover" onclick="showFullImage('${ghibliParkingImg}')"></div>
                        <div class="scroll-item h-28 w-full"><img src="${ghibliApmImages[0]}" class="w-full h-full object-cover" onclick="showFullImage('${ghibliApmImages[0]}')"></div>
                     </div>
                     <div class="flex gap-2 mt-3 text-xs">
                         <a href="https://apm-catbus.monet-technologies.co.jp/#" target="_blank" class="flex-1 bg-gray-100 text-center py-2 rounded-lg hover:bg-gray-200"><i class="fa-solid fa-bus mr-1 text-cat-orange"></i>é¾è²“å·´å£«</a>
                         <a href="https://www.aichi-koen.com/wp-content/uploads/2025/03/busmap-2.pdf" target="_blank" class="flex-1 bg-gray-100 text-center py-2 rounded-lg hover:bg-gray-200"><i class="fa-solid fa-map mr-1 text-cat-orange"></i>å…è²»æ¥é§åœ–</a>
                     </div>
                </div>
                 <div class="mb-8">
                     <h3 class="font-bold text-lg text-muji-text mb-3 border-l-4 border-cat-orange pl-3">2. æ”»ç•¥åœ°åœ–</h3>
                     <img src="${ghibliStrategyImg}" class="w-full rounded-xl shadow-sm mb-2" onclick="showFullImage('${ghibliStrategyImg}')">
                </div>
                <div>
                    <h3 class="font-bold text-lg text-muji-text mb-3 border-l-4 border-cat-orange pl-3">3. é€±æ—¥é€†å‘æ”»ç•¥</h3>
                    <div class="space-y-4 text-sm text-gray-700 leading-relaxed">
                        <div class="bg-orange-50 p-3 rounded-xl border border-orange-100">
                            <span class="text-[10px] font-bold bg-cat-orange text-white px-2 py-0.5 rounded">08:15 èµ·è·‘</span>
                            <p class="font-bold mt-1">æ¶è³¼ APM è²“å·´å£«ç¥¨</p>
                            <p class="text-xs text-gray-600">åœ°é»ï¼šé­”æ³•å…¬ä¸»ä¹‹é‡Œæ—å”®ç¥¨æ©Ÿã€‚<br>ç›®æ¨™ï¼š09:00-09:30 å¾€ã€Œå’šå’šå­ä¹‹æ£®ã€ã€‚</p>
                        </div>
                        <div class="pl-2 border-l-2 border-gray-200 ml-2 space-y-4 text-xs">
                            <div><strong class="text-cat-orange">09:00 APM è²“å·´å£«</strong><br>ç©¿è¶Šæ£®æ— (ç´„10åˆ†) æŠµé”å’šå’šå­ä¹‹æ£®ã€‚</div>
                            <div><strong class="text-cat-orange">09:15 å’šå’šå­ä¹‹æ£®</strong><br>å°æ¢…èˆ‡å°æœˆä¹‹å®¶ (Premium)ã€‚çˆ¬å±±çœ‹å¤§é¾è²“ã€‚</div>
                            <div><strong class="text-cat-orange">10:35 é­”å¥³ä¹‹è°· (é‡é»)</strong><br>éœçˆ¾åŸå ¡(å¿…çœ‹)ã€æ­å…¶è«¾å¤§å®…ã€éºµåŒ…åº—ã€é­”å¥³ä¹‹å®¶ã€‚</div>
                            <div><strong class="text-cat-orange">12:00 é’æ˜¥ä¹‹ä¸˜</strong><br>è²“å’ªäº‹å‹™æ‰€ & åœ°çƒå±‹ã€‚</div>
                        </div>
                        <div class="bg-red-50 p-2 rounded-lg text-xs text-red-600"><i class="fa-solid fa-triangle-exclamation mr-1"></i>å®¤å…§ç¦æ‹ / ç¦å¸¶å¤–é£Ÿ</div>
                    </div>
                </div>
            `;

            container.innerHTML = `
            <div class="p-6">
                ${createGuideCard('jr', 'JR Gate Tower', 'Shopping', jrContent, parkingImages[0])}
                ${createGuideCard('suzuka', 'éˆ´é¹¿è³½é“é£¯åº—', 'Hotel', suzukaContent, suzukaImages[0])}
                ${createGuideCard('ghibli', 'å‰åœåŠ›å…¬åœ’', 'Theme Park', ghibliContent, ghibliStrategyImg)}
            </div>`;
        }

        function toggleGuide(id) {
            const content = document.getElementById(`guide-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // --- 3. WALLET MODULE ---
        function renderWallet(container) {
            const totalYen = expenses.reduce((sum, item) => sum + item.amount, 0);
            const totalTwd = Math.round(totalYen * walletRate);

            container.innerHTML = `
            <div class="p-4 space-y-6">
                <div class="bg-cat-orange text-white p-6 rounded-3xl shadow-floating relative overflow-hidden transition-transform transform hover:scale-[1.01]">
                    <i class="fa-solid fa-cat absolute -right-4 -bottom-4 text-8xl opacity-20 transform rotate-12"></i>
                    <div class="mb-4">
                        <label class="text-xs opacity-80 block mb-1">åŒ¯ç‡ (1 JPY = ? TWD)</label>
                        <input type="number" step="0.001" value="${walletRate}" onchange="updateRate(this.value)" class="bg-white/20 text-white w-24 text-center rounded px-2 py-1 outline-none font-mono">
                    </div>
                    <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm">
                        <div class="flex gap-2">
                            <input type="text" id="calc-input" placeholder="è¼¸å…¥ç®—å¼ (å¦‚ 500+200*3)" class="flex-1 bg-transparent text-white placeholder-white/50 outline-none font-mono text-lg" onkeydown="handleCalcKey(event)">
                            <button onclick="calculate()" class="text-white font-bold w-8"><i class="fa-solid fa-equals"></i></button>
                        </div>
                        <div id="calc-result" class="text-right text-2xl font-bold mt-2 h-8">0</div>
                        <div id="calc-twd" class="text-right text-sm opacity-80 h-5">NT$ 0</div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-soft">
                    <h3 class="font-bold text-muji-text mb-4">æ–°å¢æ¶ˆè²»</h3>
                    <div class="space-y-3">
                        <input type="text" id="exp-name" placeholder="å“é …åç¨±" class="muji-input">
                        <input type="number" id="exp-amount" placeholder="é‡‘é¡ (æ—¥å¹£)" class="muji-input">
                        <div class="flex items-center gap-3">
                            <label class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl text-center cursor-pointer hover:bg-gray-200 transition-colors">
                                <i class="fa-solid fa-camera mr-2"></i>æ‹ç…§
                                <input type="file" id="exp-img" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this)">
                            </label>
                            <button onclick="addExpense()" class="bg-cat-orange text-white px-6 py-3 rounded-xl shadow-lg font-bold">å„²å­˜</button>
                        </div>
                        <div id="preview-area" class="hidden mt-2">
                            <img id="img-preview" class="h-20 rounded-lg object-cover border border-gray-200">
                        </div>
                    </div>
                </div>

                <div class="pb-safe">
                    <div class="flex justify-between items-end mb-2 px-2">
                        <h3 class="font-bold text-muji-text">ç´€éŒ„</h3>
                        <span class="text-xs text-gray-400">ç¸½è¨ˆ Â¥${totalYen.toLocaleString()} (ç´„ NT$${totalTwd.toLocaleString()})</span>
                    </div>
                    <div class="space-y-3" id="expense-list">
                        ${expenses.slice().reverse().map((item, idx) => `
                            <div class="bg-white p-3 rounded-2xl shadow-sm flex items-center gap-3">
                                ${item.img ? `<img src="${item.img}" class="w-12 h-12 rounded-lg object-cover bg-gray-100 cursor-pointer" onclick="showFullImage('${item.img}')">` : '<div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-300"><i class="fa-solid fa-receipt"></i></div>'}
                                <div class="flex-1">
                                    <div class="font-bold text-muji-text">${item.name}</div>
                                    <div class="text-[10px] text-gray-400">${item.date}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono font-bold text-muji-text">Â¥${item.amount}</div>
                                    <div class="text-[10px] text-gray-400">NT$${Math.round(item.amount * walletRate)}</div>
                                </div>
                                <button onclick="deleteExpense(${expenses.length - 1 - idx})" class="text-gray-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }

        function updateRate(val) {
            walletRate = parseFloat(val);
            localStorage.setItem('trip_rate', walletRate);
            renderWallet(document.getElementById('app-content'));
        }

        function handleCalcKey(event) {
            if (event.key === 'Enter') {
                calculate();
                event.target.blur();
            }
        }

        function calculate() {
            const input = document.getElementById('calc-input').value;
            try {
                const res = eval(input.replace(/[^-()\d/*+.]/g, '')); 
                document.getElementById('calc-result').innerText = 'Â¥ ' + res.toLocaleString();
                document.getElementById('calc-twd').innerText = 'â‰ˆ NT$ ' + Math.round(res * walletRate).toLocaleString();
            } catch(e) {
                document.getElementById('calc-result').innerText = 'Error';
            }
        }

        let tempImgBase64 = null;
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Canvas Compress
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800; 
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        tempImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        const pArea = document.getElementById('preview-area');
                        const pImg = document.getElementById('img-preview');
                        pArea.classList.remove('hidden');
                        pImg.src = tempImgBase64;
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addExpense() {
            const name = document.getElementById('exp-name').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            if(!name || !amount) { alert('è«‹è¼¸å…¥åç¨±èˆ‡é‡‘é¡'); return; }

            const newExp = {
                name, 
                amount,
                img: tempImgBase64,
                date: new Date().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})
            };
            expenses.push(newExp);
            try {
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
            } catch (e) {
                alert('å®¹é‡å·²æ»¿ï¼Œè«‹åˆªé™¤èˆŠç´€éŒ„');
                expenses.pop();
            }
            tempImgBase64 = null;
            renderWallet(document.getElementById('app-content'));
        }

        function deleteExpense(idx) {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                expenses.splice(idx, 1);
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
                renderWallet(document.getElementById('app-content'));
            }
        }

        // --- 4. LISTS MODULE ---
        function renderLists(container) {
            const checklists = {
                'æ—…éŠè¡Œæ': [
                    'è­·ç…§x4', 'å¤–å¹£', 'E-SIM', 'å°ç£é§•ç…§+æ—¥æ–‡è­¯æœ¬', 'ä¿¡ç”¨å¡',
                    'ç™¼ç†±è¡£è¤²x1x4', 'è¡£æœx3x4', 'è¤²å­x2x4', 'å…§è¡£è¤²x8', 'è¥ªå­x6', 'èƒŒå¿ƒx1x3', 'åœå·¾',
                    'æ´—é¢ä¹³', 'å¸å¦ä¹³', 'åŒ–å¦å“', 'ä¿é¤Šå“', 'ä¹³æ¶²', 'è­·å”‡è†', 'é˜²æ™’', 'ç‰™åˆ·', 'ç‰™è†',
                    'æ³³è¡£x4', 'æ³³å¸½x4', 'è›™é¡x4', 'æµ´å·¾x4', 'æŠ˜ç–Šè¡£æ¶',
                    'å°¿å¸ƒ', 'è¡›ç”Ÿæ£‰', 'é¢ç´™', 'æ¿•ç´™å·¾',
                    'æ‰‹æ©Ÿ/æ‰‹éŒ¶å……é›»ç·š', 'å……é›»Hub', 'å„ç¨®å……é›»ç·šæ', 'å……æ°£å¹«æµ¦',
                    'å‚™ç”¨è—¥', 'å…‹æµæ„Ÿ', 'æŒ‡ç”²åˆ€', 'é«”æº«è¨ˆ', 'å£ç½©', 'æ—¥å¸¸è—¥è†', 'æšˆè»Šè—¥'
                ],
                'æ»‘é›ªæ¸…å–®': [
                    'é›ªè¡£x4', 'é›ªè¤²x4', 'æ’æ±—è¡£è¤²x4', 'ä¸­å±¤ä¿æš–x4', 'é›ªé¡x4', 'é¢ç½©x4', 'æ¯›å¸½x4',
                    'é˜²æ‘”è¤²x4', 'è­·è†x4', 'è­·è‚˜x2(å°å­©)', 'é›ªè¥ªx4', 'æ‰‹å¥—x4', 'å…§å±¤æ‰‹å¥—x2(å¤§äºº)'
                ]
            };

            const createChecklistHTML = (title, items) => `
                <div class="bg-white rounded-3xl overflow-hidden shadow-soft transition-all mb-4">
                    <div class="p-4 bg-cat-light border-b border-orange-100 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <h3 class="font-bold text-muji-text text-base"><i class="fa-solid fa-suitcase mr-2 text-cat-orange"></i>${title}</h3>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </div>
                    <div class="p-4 grid grid-cols-1 gap-2">
                        ${items.map(item => `
                            <label class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer border border-transparent hover:border-gray-100">
                                <div class="relative flex items-center">
                                    <input type="checkbox" onchange="toggleCheck('${item}')" ${checklistState[item] ? 'checked' : ''} class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-gray-300 transition-all checked:border-cat-orange checked:bg-cat-orange">
                                    <i class="fa-solid fa-check text-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 peer-checked:text-gray-400 peer-checked:line-through">${item}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = `
            <div class="p-4 space-y-4">
                ${createChecklistHTML('æ—…éŠè¡Œææ¸…å–®', checklists['æ—…éŠè¡Œæ'])}
                ${createChecklistHTML('æ»‘é›ªæ¸…å–®', checklists['æ»‘é›ªæ¸…å–®'])}
                
                <div class="bg-white rounded-3xl p-5 shadow-soft h-[300px] flex flex-col mt-6">
                    <h3 class="font-bold text-muji-text mb-2 border-l-4 border-cat-orange pl-3">å‚™å¿˜éŒ„</h3>
                    <textarea id="memo-area" class="flex-1 w-full bg-muji-bg rounded-xl p-3 text-sm leading-relaxed outline-none resize-none border border-transparent focus:border-cat-orange" placeholder="è¼¸å…¥ç¶²å€æœƒè‡ªå‹•è®ŠæˆæŒ‰éˆ•...">${memoContent}</textarea>
                    <div class="mt-3 flex justify-between items-center">
                         <div id="memo-links" class="flex gap-2 overflow-x-auto max-w-[200px]"></div>
                         <button onclick="saveMemo()" class="bg-cat-orange text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md">å„²å­˜</button>
                    </div>
                </div>
            </div>`;
            updateMemoLinks();
        }

        function toggleCheck(item) {
            checklistState[item] = !checklistState[item];
            localStorage.setItem('trip_checklist', JSON.stringify(checklistState));
        }

        function saveMemo() {
            const val = document.getElementById('memo-area').value;
            localStorage.setItem('trip_memo', val);
            memoContent = val;
            updateMemoLinks();
            alert('å·²å„²å­˜');
        }

        function updateMemoLinks() {
            const matches = memoContent.match(/(https?:\/\/[^\s]+)/g);
            const linkContainer = document.getElementById('memo-links');
            if(linkContainer) {
                if(matches) {
                    linkContainer.innerHTML = matches.map((url, i) => 
                        `<a href="${url}" target="_blank" class="bg-gray-100 text-cat-orange text-xs px-2 py-1 rounded whitespace-nowrap"><i class="fa-solid fa-link"></i> Link ${i+1}</a>`
                    ).join('');
                } else {
                    linkContainer.innerHTML = '';
                }
            }
        }

        // --- 5. INFO MODULE ---
        function renderInfo(container) {
            container.innerHTML = `
            <div class="p-4 space-y-4">
                <div class="bg-blue-50 p-5 rounded-2xl shadow-sm border border-blue-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-cloud-sun"></i></div>
                        <h3 class="font-bold text-blue-900">å¤©æ°£é å ±</h3>
                    </div>
                    <a href="https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=230000" target="_blank" class="block bg-white text-center py-2 rounded-lg text-blue-600 font-bold text-sm shadow-sm">
                        æŸ¥çœ‹åå¤å±‹ (æ—¥æœ¬æ°£è±¡å»³)
                    </a>
                </div>
                <div class="bg-red-50 p-5 rounded-2xl shadow-sm border border-red-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-phone"></i></div>
                        <h3 class="font-bold text-red-900">ç·Šæ€¥è¯çµ¡</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="bg-white p-2 rounded-lg text-center"><div class="text-xs text-gray-500">è­¦å¯Ÿå±€</div><div class="text-lg font-black text-red-600 font-mono">110</div></div>
                        <div class="bg-white p-2 rounded-lg text-center"><div class="text-xs text-gray-500">æ•‘è­·è»Š</div><div class="text-lg font-black text-red-600 font-mono">119</div></div>
                    </div>
                     <div class="bg-white p-3 rounded-lg text-xs text-gray-600">
                        <strong>å°åŒ—é§å¤§é˜ªç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™•ï¼š</strong><br>
                        090-8794-4568 (ç·Šæ€¥)
                    </div>
                </div>
                 <div class="bg-white p-5 rounded-2xl shadow-soft">
                    <h3 class="font-bold text-muji-text mb-3"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-2"></i>æ³¨æ„äº‹é …</h3>
                    <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                        <li>é›»å£“ 100V (é›™æ‰è…³æ’é ­)ã€‚</li>
                        <li>è‡ªé§•è«‹å‹™å¿…éµå®ˆã€Œè¡Œäººå„ªå…ˆã€èˆ‡ã€Œå³é§•å·¦è¡Œã€ã€‚</li>
                        <li>å…¥å¢ƒç¦æ­¢æ”œå¸¶è‚‰é¡è£½å“ã€‚</li>
                    </ul>
                </div>
            </div>`;
        }

        function showFullImage(src) {
            document.getElementById('img-modal-src').src = src;
            document.getElementById('img-modal').classList.remove('hidden');
        }

        // --- Start App ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
